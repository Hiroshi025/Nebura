<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administración - Nebura</title>
  <meta name="description" content="Panel de administración de Nebura Works">
  <meta name="keywords" content="Nebura, Admin, Dashboard, Licencias, Usuarios, Logs">
  <meta name="author" content="Nebura">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="shortcut icon" href="/images/logo.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/administrator.css">
  <script>
    window.licenses = JSON.parse("<%- JSON.stringify(licenses).replace(/\\/g, '\\\\').replace(/\"/g, '\\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r') %>");
    window.logs = JSON.parse("<%- JSON.stringify(recentLogs).replace(/\\/g, '\\\\').replace(/\"/g, '\\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r') %>");
    window.users = JSON.parse("<%- JSON.stringify(users).replace(/\\/g, '\\\\').replace(/\"/g, '\\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r') %>");
    window.userIdFromUrl = JSON.parse('<%- JSON.stringify(userIdFromUrl) %>');
    window.usersMap = JSON.parse('<%- JSON.stringify(usersMap) %>');
    window.user = JSON.parse('<%- JSON.stringify(user) %>');
  </script>
</head>

<body>
  <div id="tsparticles"></div>
  <div id="app-container">
    <div class="d-flex" style="min-height: 100vh;">
      <!-- SIDEBAR -->
      <%- include('partials/sidebar', { user: user, panelPrincipalHtml: ` <li class="nav-item">
        <a class="nav-link" id="tickets-link" href="#">
          <i class="fas fa-ticket-alt"></i>
          <span>Tickets</span>
        </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/dashboard/support">
            <i class="fas fa-headset"></i>
            <span>Soporte</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://help.hiroshi-dev.me/">
            <i class="fas fa-book"></i>
            <span>Documentacion</span>
          </a>
        </li>
        ` }) %>
        <!-- CONTENIDO PRINCIPAL -->
        <main class="flex-grow-1 p-4">
          <!-- HEADER DE ACCIONES (tema e idioma) -->
          <div class="d-flex justify-content-end align-items-center mb-3 gap-3">
            <!-- Buscador global -->
            <div class="search-group" id="global-search-group" style="width:320px;">
              <i class="fas fa-search search-icon"></i>
              <input type="text" id="global-search" class="form-control form-control-sm" autocomplete="off"
                placeholder="Buscar en todo el panel..." />
              <button type="button" class="clear-btn" id="clear-global-search" tabindex="-1"
                aria-label="Limpiar búsqueda">
                <i class="fas fa-times-circle"></i>
              </button>
            </div>
            <!-- Cambiar idioma -->
            <div class="language-switcher">
              <a href="#" class="lang-link active" data-lang="es">ES</a> |
              <a href="#" class="lang-link" data-lang="en">EN</a>
            </div>
            <!-- Cambiar tema -->
            <div class="form-check form-switch ms-3">
              <input class="form-check-input" type="checkbox" id="themeSwitch" checked>
              <label class="form-check-label" for="themeSwitch">
                <i class="fas fa-sun"></i>
              </label>
            </div>
          </div>

          <!-- SECCIÓN DE BIENVENIDA -->
          <div class="admin-header d-flex align-items-center fade-in">
            <img
              src="<%= user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=256` : '/images/logo.png' %>"
              alt="Admin Avatar" class="admin-avatar">
            <div>
              <div class="welcome-title">Bienvenido, <%= user.name || user.global_name || user.username %>
              </div>
              <div class="welcome-desc">Panel de administración de Nebura. Gestiona usuarios, licencias, métricas,
                clientes
                y logs desde un solo lugar.</div>
              <div class="admin-badges mt-2">
                <span class="badge badge-role <%= user.role %> text-uppercase"><i class="fas fa-user-shield me-1"></i>
                  <%= user.role %>
                </span>
                <span class="badge bg-secondary"><i class="fas fa-envelope me-1"></i>
                  <%= user.email %>
                </span>
                <span class="badge bg-dark"><i class="fas fa-calendar-alt me-1"></i> Registrado: <%= user.createdAt ?
                    user.createdAt.toLocaleDateString() : '-' %></span>
              </div>
            </div>
          </div>

          <!-- NAV TABS -->
          <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-tab-pane"
                type="button" role="tab" aria-controls="info-tab-pane" aria-selected="true">
                <i class="fas fa-info-circle"></i> Información
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-tab-pane"
                type="button" role="tab" aria-controls="config-tab-pane" aria-selected="false">
                <i class="fas fa-cogs"></i> Configuración
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-tab-pane"
                type="button" role="tab" aria-controls="tasks-tab-pane" aria-selected="false">
                <i class="fa-solid fa-list-check"></i> Tareas
              </button>
            </li>
            <!-- NUEVA PESTAÑA PARA LICENCIAS -->
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="licensesui-tab" data-bs-toggle="tab" data-bs-target="#licensesui-tab-pane"
                type="button" role="tab" aria-controls="licensesui-tab-pane" aria-selected="false">
                <i class="fa-solid fa-key"></i> Licencias
              </button>
            </li>
          </ul>

          <div class="tab-content" id="adminTabsContent">
            <!-- TAB INFORMACIÓN -->
            <div class="tab-pane fade show active" id="info-tab-pane" role="tabpanel" aria-labelledby="info-tab"
              tabindex="0">
              <!-- MÉTRICAS DEL SISTEMA -->
              <div class="row fade-in">
                <div class="col-md-3">
                  <div class="count-box">
                    <div class="section-title mb-2"><i class="fas fa-users"></i> Usuarios</div>
                    <h2>
                      <%= users.length %>
                    </h2>
                    <div class="text-muted">Total registrados</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="count-box">
                    <div class="section-title mb-2"><i class="fas fa-key"></i> Licencias</div>
                    <h2>
                      <%= licenses.length %>
                    </h2>
                    <div class="text-muted">Total emitidas</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="count-box">
                    <div class="section-title mb-2"><i class="fas fa-server"></i> Clientes Discord</div>
                    <h2>
                      <%= myclientDiscord.length %>
                    </h2>
                    <div class="text-muted">Integraciones</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="count-box">
                    <div class="section-title mb-2"><i class="fas fa-chart-line"></i> Métricas</div>
                    <h2>
                      <%= metrics.length %>
                    </h2>
                    <div class="text-muted">Endpoints monitorizados</div>
                  </div>
                </div>
              </div>

              <!-- USUARIOS -->
              <div class="card fade-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="section-title mb-0"><i class="fas fa-users"></i> Usuarios</span>
                  <div class="d-flex align-items-center gap-2">
                    <!-- Botón modo compacto/expandido -->
                    <button class="btn btn-outline-secondary btn-sm" id="users-compact-toggle"
                      title="Modo compacto/expandido">
                      <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                    <!-- Botón columnas configurables -->
                    <button class="btn btn-outline-secondary btn-sm" id="users-columns-toggle" title="Columnas">
                      <i class="fas fa-table-columns"></i>
                    </button>
                    <!-- Botón exportar -->
                    <div class="dropdown">
                      <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-file-export"></i> Exportar
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" id="export-users-csv">CSV</a></li>
                        <li><a class="dropdown-item" href="#" id="export-users-xlsx">Excel</a></li>
                      </ul>
                    </div>
                    <div class="search-group search-group-animate-in" id="users-search-group">
                      <i class="fas fa-search search-icon"></i>
                      <input type="text" id="search-users" class="form-control form-control-sm" autocomplete="off"
                        placeholder="Buscar por nombre, email o rol" />
                      <button type="button" class="clear-btn" id="clear-search-users" tabindex="-1"
                        aria-label="Limpiar búsqueda">
                        <i class="fas fa-times-circle"></i>
                      </button>
                      <span class="search-spinner" id="spinner-search-users"></span>
                    </div>
                    <select class="advanced-filter" id="users-advanced-filter">
                      <option value="">Todos</option>
                      <option value="name">Nombre</option>
                      <option value="email">Email</option>
                      <option value="role">Rol</option>
                    </select>
                    <!-- <span class="text-muted">Total: <%= users.length %></span> -->
                  </div>
                </div>
                <div class="card-body table-responsive">
                  <!-- Filtros avanzados -->
                  <div class="row mb-2">
                    <div class="col-md-4">
                      <input type="date" class="form-control form-control-sm" id="users-filter-date-from"
                        placeholder="Desde">
                    </div>
                    <div class="col-md-4">
                      <input type="date" class="form-control form-control-sm" id="users-filter-date-to"
                        placeholder="Hasta">
                    </div>
                    <div class="col-md-4">
                      <select class="form-select form-select-sm" id="users-filter-status">
                        <option value="">Todos los estados</option>
                        <option value="inactive">Inactivo</option>
                        <option value="active">Activo</option>
                      </select>
                    </div>
                  </div>
                  <table class="table table-hover align-middle mb-0" id="users-table">
                    <thead>
                      <tr>
                        <th style="cursor:pointer" data-sort="name" class="sortable">Nombre <i class="fa fa-sort"></i>
                        </th>
                        <th style="cursor:pointer" data-sort="email" class="sortable">Email <i class="fa fa-sort"></i>
                        </th>
                        <th style="cursor:pointer" data-sort="role" class="sortable">Rol <i class="fa fa-sort"></i></th>
                        <th style="cursor:pointer" data-sort="createdAt" class="sortable">Registrado <i
                            class="fa fa-sort"></i></th>
                        <th style="cursor:pointer" data-sort="licenses" class="sortable">Licencias <i
                            class="fa fa-sort"></i></th>
                        <th style="cursor:pointer" data-sort="updatedAt" class="sortable">Última actualización <i
                            class="fa fa-sort"></i></th>
                      </tr>
                    </thead>
                    <tbody id="users-table-body">
                      <% users.forEach(u=> { %>
                        <tr>
                          <td>
                            <span class="badge bg-primary" style="font-size:0.95em;cursor:pointer;"
                              data-bs-toggle="tooltip" title="Nombre de usuario">
                              <%= u.name %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-secondary" style="font-size:0.95em;cursor:pointer;"
                              data-bs-toggle="tooltip" title="Email">
                              <%= u.email %>
                            </span>
                          </td>
                          <td>
                            <span class="badge badge-role <%= u.role %> text-uppercase"
                              style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Rol">
                              <%= u.role %>
                            </span>
                          </td>
                          <td>
                            <span data-bs-toggle="tooltip" title="Fecha de registro">
                              <%= u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '-' %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-info" style="font-size:0.95em;cursor:pointer;"
                              data-bs-toggle="tooltip" title="Cantidad de licencias">
                              <%= licenses.filter(l=> l.userId === u.id).length %>
                            </span>
                          </td>
                          <td>
                            <span data-bs-toggle="tooltip" title="Última actualización">
                              <%= u.updatedAt ? new Date(u.updatedAt).toLocaleDateString() : '-' %>
                            </span>
                          </td>
                        </tr>
                        <% }) %>
                    </tbody>
                  </table>
                  <nav>
                    <ul class="pagination pagination-sm justify-content-end" id="users-pagination"></ul>
                  </nav>
                </div>
              </div>

              <!-- LICENCIAS -->
              <div class="card fade-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="section-title mb-0"><i class="fas fa-key"></i> Licencias</span>
                  <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="licenses-compact-toggle"
                      title="Modo compacto/expandido">
                      <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="licenses-columns-toggle" title="Columnas">
                      <i class="fas fa-table-columns"></i>
                    </button>
                    <div class="dropdown">
                      <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-file-export"></i> Exportar
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" id="export-licenses-csv">CSV</a></li>
                        <li><a class="dropdown-item" href="#" id="export-licenses-xlsx">Excel</a></li>
                      </ul>
                    </div>
                    <div class="search-group search-group-animate-in" id="licenses-search-group">
                      <i class="fas fa-search search-icon"></i>
                      <input type="text" id="search-licenses" class="form-control form-control-sm" autocomplete="off"
                        placeholder="Buscar por ID, tipo, usuario, admin o estado" />
                      <button type="button" class="clear-btn" id="clear-search-licenses" tabindex="-1"
                        aria-label="Limpiar búsqueda">
                        <i class="fas fa-times-circle"></i>
                      </button>
                      <span class="search-spinner" id="spinner-search-licenses"></span>
                    </div>
                    <select class="advanced-filter" id="licenses-advanced-filter">
                      <option value="">Todos</option>
                      <option value="id">ID</option>
                      <option value="type">Tipo</option>
                      <option value="user">Usuario</option>
                      <option value="admin">Admin</option>
                      <option value="status">Estado</option>
                    </select>
                    <!-- <span class="text-muted">Total: <%= licenses.length %></span> -->
                  </div>
                </div>
                <div class="card-body table-responsive">
                  <div class="row mb-2">
                    <div class="col-md-4">
                      <input type="date" class="form-control form-control-sm" id="licenses-filter-date-from"
                        placeholder="Desde">
                    </div>
                    <div class="col-md-4">
                      <input type="date" class="form-control form-control-sm" id="licenses-filter-date-to"
                        placeholder="Hasta">
                    </div>
                    <div class="col-md-4">
                      <select class="form-select form-select-sm" id="licenses-filter-status">
                        <option value="">Todos los estados</option>
                        <option value="ACTIVE">Activa</option>
                        <option value="EXPIRED">Expirada</option>
                        <option value="BANNED">Baneada</option>
                        <option value="REVOKED">Revocada</option>
                      </select>
                    </div>
                  </div>
                  <table class="table table-hover align-middle mb-0" id="licenses-table">
                    <thead>
                      <tr>
                        <th style="cursor:pointer" data-sort="id" class="sortable">ID <i class="fa fa-sort"></i></th>
                        <th style="cursor:pointer" data-sort="type" class="sortable">Tipo <i class="fa fa-sort"></i>
                        </th>
                        <th style="cursor:pointer" data-sort="user" class="sortable">Usuario <i class="fa fa-sort"></i>
                        </th>
                        <th style="cursor:pointer" data-sort="admin" class="sortable">Admin <i class="fa fa-sort"></i>
                        </th>
                        <th>HWID</th>
                        <th style="cursor:pointer" data-sort="status" class="sortable">Estado <i class="fa fa-sort"></i>
                        </th>
                        <th style="cursor:pointer" data-sort="validUntil" class="sortable">Válida hasta <i
                            class="fa fa-sort"></i></th>
                        <th style="cursor:pointer" data-sort="requests" class="sortable">Solicitudes <i
                            class="fa fa-sort"></i></th>
                        <th>Última IP</th>
                      </tr>
                    </thead>
                    <tbody id="licenses-table-body">
                      <% licenses.forEach(l=> {
                        let userLic=users.find(u=> u.id === l.userId);
                        let adminLic=users.find(u=> u.id === l.adminId);
                        let status = 'ACTIVE';
                        if (l.validUntil && new Date(l.validUntil) < new Date()) status='EXPIRED' ; if
                          (l.status==='BANNED' ) status='BANNED' ; if (l.status==='REVOKED' ) status='REVOKED' ; let
                          estadoIcon=status==='ACTIVE'
                          ? '<i class="fa fa-check-circle text-success" title="Activa"></i>' : status==='EXPIRED'
                          ? '<i class="fa fa-clock text-warning" title="Expirada"></i>'
                          : '<i class="fa fa-ban text-danger" title="Revocada/Baneada"></i>' ; %>
                          <tr>
                            <td>
                              <span class="badge bg-primary" style="font-size:0.95em;cursor:pointer;"
                                data-bs-toggle="tooltip" title="ID de licencia">
                                <%= l.id %>
                              </span>
                            </td>
                            <td>
                              <span class="badge bg-info" style="font-size:0.95em;cursor:pointer;"
                                data-bs-toggle="tooltip" title="Tipo de licencia">
                                <%= l.type %>
                              </span>
                            </td>
                            <td>
                              <span class="badge bg-secondary" style="font-size:0.95em;cursor:pointer;"
                                data-bs-toggle="tooltip" title="Usuario">
                                <%= userLic ? userLic.name : l.userId %>
                              </span>
                            </td>
                            <td>
                              <span class="badge bg-secondary" style="font-size:0.95em;cursor:pointer;"
                                data-bs-toggle="tooltip" title="Admin">
                                <%= adminLic ? adminLic.name : l.adminId %>
                              </span>
                            </td>
                            <td>
                              <span class="badge bg-dark" style="font-size:0.95em;cursor:pointer;"
                                data-bs-toggle="tooltip" title="HWID">
                                <%= Array.isArray(l.hwid) ? l.hwid.join(', ') : '' %>
                        </span>
                      </td>
                      <td>
                        <span class="badge badge-status <%= status %> <%= status === ' ACTIVE' ? 'bg-success' :
                                  status==='EXPIRED' ? 'bg-warning text-dark' : 'bg-danger' %>" style="cursor:pointer;"
                                  data-bs-toggle="tooltip" title="<%= status==='ACTIVE' ? 'Licencia activa y válida' :
                                    status==='EXPIRED' ? 'Licencia expirada' : 'Licencia revocada/baneada' %>">
                                    <%- estadoIcon %>
                                      <%= status %>
                              </span>
                            </td>
                            <td>
                              <span data-bs-toggle="tooltip"
                                title="<%= l.validUntil ? new Date(l.validUntil).toLocaleString() : '-' %>">
                                <%= l.validUntil ? new Date(l.validUntil).toLocaleDateString() : '-' %>
                              </span>
                            </td>
                            <td>
                              <span class="badge bg-info" style="font-size:0.95em;cursor:pointer;"
                                data-bs-toggle="tooltip" title="Solicitudes">
                                <%= l.requestCount %> / <%= l.requestLimit %>
                              </span>
                            </td>
                            <td>
                              <span class="badge bg-secondary" style="font-size:0.95em;cursor:pointer;"
                                data-bs-toggle="tooltip" title="Última IP">
                                <%= l.lastUsedIp || '-' %>
                              </span>
                            </td>
                          </tr>
                          <% }) %>
                    </tbody>
                  </table>
                  <nav>
                    <ul class="pagination pagination-sm justify-content-end" id="licenses-pagination"></ul>
                  </nav>
                </div>
              </div>

              <!-- CLIENTES -->
              <div class="card fade-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="section-title mb-0"><i class="fab fa-discord"></i> Clientes Discord</span>
                  <!-- <span class="text-muted">Total: <%= myclientDiscord.length %></span> -->
                </div>
                <div class="card-body table-responsive">
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Token</th>
                        <th>Version</th>
                        <th>Webhook</th>
                        <th>Mantenimiento</th>
                        <th>Creado</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% myclientDiscord.forEach(c=> { %>
                        <tr>
                          <td>
                            <%= c.name %>
                          </td>
                          <td><code><%= c.clientId.slice(0, 8) %>...<%= c.clientId.slice(-4) %></code></td>
                          <td>
                            <%= c.version %>
                          </td>
                          <td><span class="badge <%= c.webhookUrl ? 'bg-danger' : 'bg-secondary' %>">
                              <%= c.webhookUrl ? 'Sí' : 'No' %>
                            </span></td>
                          <td>
                            <span class="badge <%= c.maintenance ? 'bg-danger' : 'bg-secondary' %>">
                              <%= c.maintenance ? 'Sí' : 'No' %>
                            </span>
                          </td>
                          <td>
                            <%= c.createdAt ? new Date(c.createdAt).toLocaleDateString() : ' -' %>
                          </td>
                        </tr>
                        <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- MÉTRICAS -->
              <div class="card fade-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="section-title mb-0"><i class="fas fa-chart-line"></i> Métricas de Endpoints</span>
                  <!-- <span class="text-muted">Total: <%= metrics.length %></span> -->
                </div>
                <div class="card-body table-responsive">
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>Endpoint</th>
                        <th>Cliente</th>
                        <th>Sistema</th>
                        <th>Solicitudes</th>
                        <th>Errores</th>
                        <th>Latencia Promedio</th>
                        <th>Última actualización</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% metrics.forEach(m=> { %>
                        <tr>
                          <td>
                            <%= m.endpoint %>
                          </td>
                          <td>
                            <%= m.clientId || '-' %>
                          </td>
                          <td>
                            <%= m.system %>
                          </td>
                          <td>
                            <%= m.requests %>
                          </td>
                          <td><span class="badge <%= m.errors > 0 ? 'bg-danger' : 'bg-success' %>">
                              <%= m.errors %>
                            </span></td>
                          <td>
                            <%= m.latency ? m.latency.toFixed(2) : '-' %> ms
                          </td>
                          <td>
                            <%= m.updatedAt ? new Date(m.updatedAt).toLocaleDateString() : '-' %>
                          </td>
                        </tr>
                        <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- LOGS RECIENTES -->
              <div class="card fade-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="section-title mb-0"><i class="fas fa-file-alt"></i> Logs recientes</span>
                  <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="logs-compact-toggle"
                      title="Modo compacto/expandido">
                      <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="logs-columns-toggle" title="Columnas">
                      <i class="fas fa-table-columns"></i>
                    </button>
                    <div class="dropdown">
                      <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-file-export"></i> Exportar
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" id="export-logs-csv">CSV</a></li>
                        <li><a class="dropdown-item" href="#" id="export-logs-xlsx">Excel</a></li>
                      </ul>
                    </div>
                    <div class="search-group search-group-animate-in" id="logs-search-group">
                      <i class="fas fa-search search-icon"></i>
                      <input type="text" id="search-logs" class="form-control form-control-sm" autocomplete="off"
                        placeholder="Buscar por archivo" />
                      <button type="button" class="clear-btn" id="clear-search-logs" tabindex="-1"
                        aria-label="Limpiar búsqueda">
                        <i class="fas fa-times-circle"></i>
                      </button>
                      <span class="search-spinner" id="spinner-search-logs"></span>
                    </div>
                    <select class="advanced-filter" id="logs-advanced-filter">
                      <option value="">Todos</option>
                      <option value="filename">Archivo</option>
                      <option value="isCompressed">Comprimido</option>
                    </select>
                    <!-- <span class="text-muted">Últimos <%= recentLogs.length %> archivos</span> -->
                  </div>
                </div>
                <div class="card-body table-responsive">
                  <div class="row mb-2">
                    <div class="col-md-6">
                      <input type="date" class="form-control form-control-sm" id="logs-filter-date-from"
                        placeholder="Desde">
                    </div>
                    <div class="col-md-6">
                      <input type="date" class="form-control form-control-sm" id="logs-filter-date-to"
                        placeholder="Hasta">
                    </div>
                  </div>
                  <table class="table table-hover align-middle mb-0" id="logs-table">
                    <thead>
                      <tr>
                        <th style="cursor:pointer" data-sort="filename" class="sortable">Archivo <i
                            class="fa fa-sort"></i>
                        </th>
                        <th style="cursor:pointer" data-sort="lastModified" class="sortable">Última modificación <i
                            class="fa fa-sort"></i></th>
                        <th style="cursor:pointer" data-sort="size" class="sortable">Tamaño <i class="fa fa-sort"></i>
                        </th>
                        <th style="cursor:pointer" data-sort="isCompressed" class="sortable">Comprimido <i
                            class="fa fa-sort"></i></th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="logs-table-body">
                      <% recentLogs.forEach(log=> { %>
                        <tr>
                          <td>
                            <span class="badge bg-primary" style="font-size:0.95em;cursor:pointer;"
                              data-bs-toggle="tooltip" title="Nombre de archivo">
                              <%= log.filename %>
                            </span>
                          </td>
                          <td>
                            <span data-bs-toggle="tooltip" title="Última modificación">
                              <%= log.lastModified ? new Date(log.lastModified).toLocaleString() : '-' %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-info" style="font-size:0.95em;cursor:pointer;"
                              data-bs-toggle="tooltip" title="Tamaño">
                              <%= log.size %>
                            </span>
                          </td>
                          <td>
                            <span class="badge <%= log.isCompressed ? 'bg-success' : 'bg-secondary' %>"
                              style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="¿Comprimido?">
                              <%= log.isCompressed ? 'Sí' : 'No' %>
                            </span>
                          </td>
                          <td>
                            <a href="/dashboard/utils/logs/<%= log.filename %>" class="btn btn-sm btn-outline-primary"
                              target="_blank" data-bs-toggle="tooltip" title="Ver">
                              <i class="fas fa-eye"></i>
                            </a>
                            <a href="/dashboard/utils/logs/<%= log.filename %>?download=1"
                              class="btn btn-sm btn-outline-success" target="_blank" data-bs-toggle="tooltip"
                              title="Descargar">
                              <i class="fas fa-download"></i>
                            </a>
                          </td>
                        </tr>
                        <% }) %>
                    </tbody>
                  </table>
                  <nav>
                    <ul class="pagination pagination-sm justify-content-end" id="logs-pagination"></ul>
                  </nav>
                </div>
              </div>
            </div>

            <!-- TAB CONFIGURACIÓN -->
            <div class="tab-pane fade" id="config-tab-pane" role="tabpanel" aria-labelledby="config-tab" tabindex="0">
              <!-- SECCIÓN DE ACTUALIZACIÓN DE ROLES DE USUARIO -->
              <div class="card fade-in mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="section-title mb-0"><i class="fas fa-user-cog"></i> Gestión de Roles de Usuario</span>
                </div>
                <div class="card-body">
                  <% if (user.role !=="owner" ) { %>
                    <div class="alert alert-danger mb-3">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      Solo los usuarios con rango <strong>owner</strong> pueden actualizar roles.
                    </div>
                    <% } %>
                      <form id="role-update-form" class="row g-3 align-items-end" <%=(user.role &&
                        user.role.trim().toLowerCase() !=="owner" ) ? 'style="pointer-events:none;opacity:0.7;"' : '' %>
                        >
                        <div class="col-md-5">
                          <label for="select-user" class="form-label">Seleccionar usuario</label>
                          <select class="form-select" id="select-user" required>
                            <option value="" disabled selected>Elige un usuario...</option>
                            <% users.forEach(u=> { %>
                              <option value="<%= u.id %>">
                                <%= u.name %> (<%= u.email %>) - <%= u.role %>
                              </option>
                              <% }) %>
                          </select>
                        </div>
                        <div class="col-md-4">
                          <label for="select-role" class="form-label">Nuevo rol</label>
                          <select class="form-select" id="select-role" required>
                            <option value="" disabled selected>Selecciona un rol...</option>
                            <option value="admin">admin</option>
                            <option value="user">user</option>
                            <option value="guest">guest</option>
                            <option value="developer">developer</option>
                            <option value="owner">owner</option>
                          </select>
                        </div>
                        <div class="col-md-3 d-grid">
                          <button type="submit" class="btn btn-primary" <%=(user.role && user.role.trim().toLowerCase()
                            !=="owner" ) ? "disabled" : "" %>>
                            <i class="fas fa-save me-1"></i> Actualizar Rol
                          </button>
                        </div>
                      </form>
                      <div id="role-update-result" class="mt-3"></div>
                </div>
              </div>
            </div>

            <!-- TAB TASKS -->
            <div class="tab-pane fade" id="tasks-tab-pane" role="tabpanel" aria-labelledby="tasks-tab" tabindex="0">
              <%- include('partials/utils/tasks') %>
            </div>
            <!-- NUEVA TAB PARA LICENCIAS UI -->
            <div class="tab-pane fade" id="licensesui-tab-pane" role="tabpanel" aria-labelledby="licensesui-tab"
              tabindex="0">
              <%- include('partials/utils/licences', { user: user }) %>
            </div>
        </main>
    </div>
  </div>


  <!-- Toast para notificaciones -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toast-title">Notificación</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-body">Mensaje de notificación</div>
    </div>
  </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@3.3.0/tsparticles.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="/scripts/dashboard/administrator.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var link = document.getElementById('tickets-link');
        if (link && window.userIdFromUrl) {
          link.href = '/dashboard/administrator/tickets?id=<%- userIdFromUrl %>';
        }
      });
    </script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    tsParticles.load("tsparticles", {
      fullScreen: { enable: false },
      background: { color: "transparent" },
      fpsLimit: 60,
      particles: {
        number: { value: 60, density: { enable: true, area: 800 } },
        color: { value: "#4cc9f0" },
        shape: { type: "circle" },
        opacity: { value: 0.25 },
        size: { value: { min: 1, max: 3 } },
        move: { enable: true, speed: 1, direction: "none", outModes: "out" },
        links: {
          enable: true,
          distance: 120,
          color: "#4cc9f0",
          opacity: 0.15,
          width: 1
        }
      },
      detectRetina: true
    });
  });
</script>
    <!-- Modal de confirmación -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmModalLabel"><i class="fas fa-exclamation-triangle text-warning"></i>
              Confirmar acción</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="confirmModalBody">
            ¿Estás seguro de que deseas realizar esta acción?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmModalOk">Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal columnas configurables -->
    <div class="modal fade" id="columnsModal" tabindex="-1" aria-labelledby="columnsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="columnsModalLabel"><i class="fas fa-table-columns"></i> Seleccionar columnas
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="columnsModalBody">
            <!-- Se rellena dinámicamente -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary" id="columnsModalApply">Aplicar</button>
          </div>
        </div>
      </div>
    </div>
</body>

</html>