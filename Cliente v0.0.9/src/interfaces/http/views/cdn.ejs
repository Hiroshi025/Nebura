<!DOCTYPE html>
<html lang="es" data-bs-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Nebura CDN: Sube, comparte y gestiona archivos de forma segura y sencilla en la nube de Nebura Works.">
  <meta name="keywords"
    content="Nebura, CDN, archivos, compartir, nube, almacenamiento, upload, download, gestión, plataforma, seguridad">
  <meta name="author" content="Nebura">
  <meta property="og:title"
    content="<%= sharedFile ? sharedFile.title : 'Nebura CDN - Gestión y Compartición de Archivos' %>">
  <meta property="og:description"
    content="<%= sharedFile ? (sharedFile.description || 'Archivo compartido en Nebura CDN') : 'Sube, comparte y gestiona archivos fácilmente en la nube de Nebura Works.' %>">
  <% if (sharedFile && sharedFile.mimeType && sharedFile.mimeType.startsWith('image/')) { %>
    <meta property="og:image" content="<%= sharedFile.downloadUrl %>">
    <% } %>
      <meta property="og:type" content="website">
      <meta property="og:url"
        content="<%= sharedFile ? sharedFile.shareUrl : 'https://host.hiroshi-dev.me/dashboard/cdn' %>">
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:title" content="Nebura CDN - Gestión y Compartición de Archivos">
      <meta name="twitter:description"
        content="Sube, comparte y gestiona archivos fácilmente en la nube de Nebura Works. Acceso rápido y seguro a tus documentos.">

      <title>
        <%= title %>
      </title>

      <!-- Link Utils -->
      <%- include('partials/link', { user: user }) %>
      <link rel="stylesheet" href="/css/cdn.css">
</head>

<body>
  <div id="app-container">
    <div class="d-flex" style="min-height: 100vh;">
      <!-- SIDEBAR MEJORADO -->
      <%- include('partials/sidebar', { user: user, panelSection: ` <div class="sidebar-section-title">CDN
    </div>
    <ul class="nav flex-column sidebar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/dashboard/cdn">
          <i class="fas fa-folder"></i> <span>Mis Archivos</span>
        </a>
      </li>
      <!-- Otros ítems específicos de CDN -->
    </ul>
    <div class="sidebar-divider"></div>
    ` }) %>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-grow-1 p-4">
      <% if (!sharedFile) { %>
        <!-- Sección de usuario y grid de archivos -->
        <!-- User Profile Section -->
        <div id="user-profile-section" class="user-profile animate__animated animate__fadeIn">
          <div class="d-flex align-items-center">
            <img
              src="<%= user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=256` : 'https://imgs.search.brave.com/4rnnJU7_ENkK60goDh2C1fAWVhiD56t5CXuDp6Bs92o/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9jZG4u/cGl4YWJheS5jb20v/cGhvdG8vMjAxMy8w/Ny8xMy8xMC80NC9t/YW4tMTU3Njk5XzY0/MC5wbmc' %>"
              alt="User Avatar" class="user-avatar me-3">
            <div>
              <h3 class="mb-0"><%- user.global_name || user.username || user.name %></h3>
              <p class="mb-0 opacity-75">
                <% if (user.username) { %>
                  @<%- user.username %>
                    <% } else { %>
                      Role: <%- user.role %>
                        <% } %>
              </p>
              <div class="d-flex mt-2">
                <span class="badge bg-primary me-2">
                  <i class="fas fa-crown me-1"></i> <%- user.premium_type ? (user.premium_type===2 ? 'Nitro' : 'Basic' )
                    : 'Sin Suscripción' %>
                </span>
                <span class="badge bg-secondary">
                  <i class="fas fa-users me-1"></i> <%- user.guilds ? user.guilds.length : 0 %> <span
                      data-key="guildsCount">Servidores</span>
                </span>
              </div>
            </div>
          </div>
          <div class="user-stats">
            <div class="stat-item">
              <div class="stat-value" id="total-files">0</div>
              <div class="stat-label" data-key="totalFiles">Archivos Totales</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="total-size">0 MB</div>
              <div class="stat-label" data-key="totalSize">Tamaño Total</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="last-upload">-</div>
              <div class="stat-label" data-key="lastUpload">Última Subida</div>
            </div>
          </div>
        </div>

        <!-- VISTA PRINCIPAL (GRID DE ARCHIVOS) -->
        <div id="main-view">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 fw-bold" data-key="mainTitle">Mis Archivos</h1>
            <div>
              <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="fas fa-upload me-2"></i><span data-key="uploadBtn">Subir Archivo</span>
              </button>
              <button class="btn btn-outline-primary" id="refresh-btn" title="Recargar">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>

          <!-- Search and Filter Section -->
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="form-control search-input" id="search-input" placeholder="Buscar archivos..."
              data-key="searchPlaceholder">
          </div>

          <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all" data-key="filterAll">Todos</button>
            <button class="filter-btn" data-filter="image" data-key="filterImages">Imágenes</button>
            <button class="filter-btn" data-filter="video" data-key="filterVideos">Videos</button>
            <button class="filter-btn" data-filter="audio" data-key="filterAudio">Audio</button>
            <button class="filter-btn" data-filter="document" data-key="filterDocuments">Documentos</button>
            <button class="filter-btn" data-filter="other" data-key="filterOther">Otros</button>
          </div>

          <div id="file-grid" class="row g-4">
            <!-- Las tarjetas de archivos se insertarán aquí -->
          </div>
          <div id="loading-spinner" class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
          <div id="no-files-message" class="text-center text-muted my-5 d-none">
            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
            <h4 data-key="noFilesTitle">No hay archivos todavía</h4>
            <p data-key="noFilesSubtitle">¡Sube tu primer archivo para empezar!</p>
          </div>
        </div>
        <% } %>

          <% if (sharedFile) { %>
            <!-- Solo mostrar la vista de archivo compartido -->
            <div id="shared-file-view" style="display:block;">
              <div class="d-flex justify-content-center">
                <div class="card file-card" style="max-width: 800px; width: 100%;">
                  <div id="shared-file-content">
                    <!-- El contenido del archivo compartido se insertará aquí por JS -->
                  </div>
                </div>
              </div>
            </div>
            <% } %>
    </main>
  </div>

  <!-- Modal de Subida -->
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold" id="uploadModalLabel" data-key="modalTitle">Subir Nuevo Archivo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="uploadForm">
            <div class="mb-3">
              <label for="fileTitle" class="form-label" data-key="fileTitleLabel">Título del Archivo</label>
              <input type="text" class="form-control" id="fileTitle" required>
            </div>
            <div class="mb-3">
              <label for="fileDescription" class="form-label" data-key="fileDescriptionLabel">Descripción
                (Opcional)</label>
              <textarea class="form-control" id="fileDescription" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label" data-key="fileSelectLabel">Archivo</label>
              <div id="drop-zone" class="drop-zone">
                <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                <p class="mb-0" data-key="dropZoneText">Arrastra y suelta un archivo aquí o haz clic para
                  seleccionar
                </p>
                <small id="file-name-display" class="text-primary"></small>
                <div class="upload-progress mt-2">
                  <div class="upload-progress-bar"></div>
                </div>
              </div>
              <input type="file" id="fileInput" class="d-none" required>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary" id="submit-upload-btn">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                <span data-key="modalUploadBtn">Subir Archivo</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="modal fade file-preview-modal" id="filePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="modal-body p-0">
          <div id="file-preview-content" class="w-100 h-100 d-flex justify-content-center align-items-center">
            <!-- Preview content will be inserted here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast para notificaciones -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toast-title"></strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-body"></div>
    </div>
  </div>

  <!-- footer -->
  <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
      window.addEventListener('load', function () {
        // Mostrar un loader mientras se carga todo
        document.body.classList.add('loaded');
      });

      document.addEventListener('DOMContentLoaded', function () {
        // --- CONFIGURACIÓN Y ESTADO ---
        const USER_ID = JSON.parse('<%- JSON.stringify(user.id) %>');
        const USER_DATA = JSON.parse('<%- JSON.stringify(user) %>');
        let currentLanguage = 'es';
        let currentFiles = [];
        const toastElement = document.getElementById('notificationToast');
        const notificationToast = new bootstrap.Toast(toastElement);
        const filePreviewModal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
        const userAvatar = document.querySelector('.user-avatar');

        // --- DICCIONARIO DE TRADUCCIONES ---
        const translations = {
          en: {
            mainTitle: "My Files", uploadBtn: "Upload File", modalTitle: "Upload New File",
            fileTitleLabel: "File Title", fileDescriptionLabel: "Description (Optional)",
            fileSelectLabel: "File", dropZoneText: "Drag & drop a file here or click to select",
            modalUploadBtn: "Upload File", noFilesTitle: "No files yet", noFilesSubtitle: "Upload your first file to get started!",
            viewBtn: "View", downloadBtn: "Download", shareBtn: "Share", deleteBtn: "Delete",
            uploadDate: "Uploaded", fileSize: "Size", fileSharedTitle: "Shared File",
            copiedSuccess: "Link copied to clipboard!", deleteConfirm: "Are you sure you want to delete this file?",
            deleteSuccess: "File deleted successfully.", uploadSuccess: "File uploaded successfully!",
            errorFetch: "Error fetching files.", errorUpload: "Error uploading file.", errorDelete: "Error deleting file.",
            searchPlaceholder: "Search files...", filterAll: "All", filterImages: "Images", filterVideos: "Videos",
            filterAudio: "Audio", filterDocuments: "Documents", filterOther: "Other", totalFiles: "Total Files",
            totalSize: "Total Size", lastUpload: "Last Upload", previewBtn: "Preview", fileType: "Type",
            image: "Image", video: "Video", audio: "Audio", pdf: "PDF", document: "Document", archive: "Archive", other: "Other"
          },
          es: {
            mainTitle: "Mis Archivos", uploadBtn: "Subir Archivo", modalTitle: "Subir Nuevo Archivo",
            fileTitleLabel: "Título del Archivo", fileDescriptionLabel: "Descripción (Opcional)",
            fileSelectLabel: "Archivo", dropZoneText: "Arrastra y suelta un archivo aquí o haz clic para seleccionar",
            modalUploadBtn: "Subir Archivo", noFilesTitle: "No hay archivos todavía", noFilesSubtitle: "¡Sube tu primer archivo para empezar!",
            viewBtn: "Ver", downloadBtn: "Descargar", shareBtn: "Compartir", deleteBtn: "Eliminar",
            uploadDate: "Subido el", fileSize: "Tamaño", fileSharedTitle: "Archivo Compartido",
            copiedSuccess: "¡Enlace copiado al portapapeles!", deleteConfirm: "¿Estás seguro de que quieres eliminar este archivo?",
            deleteSuccess: "Archivo eliminado correctamente.", uploadSuccess: "¡Archivo subido con éxito!",
            errorFetch: "Error al cargar los archivos.", errorUpload: "Error al subir el archivo.", errorDelete: "Error al eliminar el archivo.",
            searchPlaceholder: "Buscar archivos...", filterAll: "Todos", filterImages: "Imágenes", filterVideos: "Videos",
            filterAudio: "Audio", filterDocuments: "Documentos", filterOther: "Otros", totalFiles: "Archivos Totales",
            totalSize: "Tamaño Total", lastUpload: "Última Subida", previewBtn: "Vista Previa", fileType: "Tipo",
            image: "Imagen", video: "Video", audio: "Audio", pdf: "PDF", document: "Documento", archive: "Archivo", other: "Otro"
          }
        };

        // --- ELEMENTOS DEL DOM ---
        const themeSwitch = document.getElementById('themeSwitch');
        const themeIcon = document.querySelector('label[for="themeSwitch"] i');
        const langLinks = document.querySelectorAll('.lang-link');
        const mainView = document.getElementById('main-view');
        const sharedFileView = document.getElementById('shared-file-view');
        const fileGrid = document.getElementById('file-grid');
        const uploadForm = document.getElementById('uploadForm');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('file-name-display');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noFilesMessage = document.getElementById('no-files-message');
        const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
        const searchInput = document.getElementById('search-input');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const uploadProgress = document.querySelector('.upload-progress');
        const uploadProgressBar = document.querySelector('.upload-progress-bar');
        const totalFilesElement = document.getElementById('total-files');
        const totalSizeElement = document.getElementById('total-size');
        const lastUploadElement = document.getElementById('last-upload');

        // --- FUNCIONES DE AYUDA ---
        const showToast = (title, body, type = 'success') => {
          const toastTitle = document.getElementById('toast-title');
          const toastBody = document.getElementById('toast-body');
          toastTitle.textContent = title;
          toastBody.textContent = body;
          toastElement.classList.remove('bg-success', 'bg-danger', 'text-white');
          if (type === 'success') {
            toastElement.classList.add('bg-success', 'text-white');
          } else {
            toastElement.classList.add('bg-danger', 'text-white');
          }
          notificationToast.show();
        };

        const formatDate = (dateString) => new Date(dateString).toLocaleDateString(currentLanguage, {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        const formatSize = (bytes) => {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const getFileType = (mimeType) => {
          const type = mimeType.split('/')[0];
          const specificType = mimeType.split('/')[1];

          if (type === 'image') return 'image';
          if (type === 'video') return 'video';
          if (type === 'audio') return 'audio';
          if (mimeType === 'application/pdf') return 'pdf';
          if (mimeType.includes('word') || mimeType.includes('excel') || mimeType.includes('powerpoint') || mimeType.includes('text')) return 'document';
          if (mimeType.includes('zip') || mimeType.includes('compressed') || mimeType.includes('archive')) return 'archive';
          return 'other';
        };

        const getFileIcon = (mimeType) => {
          const iconMap = {
            'image': 'fa-solid fa-file-image', 'audio': 'fa-solid fa-file-audio',
            'video': 'fa-solid fa-file-video', 'pdf': 'fa-solid fa-file-pdf',
            'archive': 'fa-solid fa-file-zipper', 'document': 'fa-solid fa-file-lines',
            'other': 'fa-solid fa-file'
          };
          const fileType = getFileType(mimeType);
          return iconMap[fileType] || iconMap['other'];
        };

        const getFileTypeName = (mimeType) => {
          const fileType = getFileType(mimeType);
          return translations[currentLanguage][fileType] || translations[currentLanguage]['other'];
        };

        const updateUserStats = (files) => {
          if (!files || files.length === 0) {
            totalFilesElement.textContent = '0';
            totalSizeElement.textContent = '0 MB';
            lastUploadElement.textContent = '-';
            return;
          }

          // Total files
          totalFilesElement.textContent = files.length;

          // Total size
          const totalSize = files.reduce((sum, file) => sum + file.size, 0);
          totalSizeElement.textContent = formatSize(totalSize);

          // Last upload
          const sortedFiles = [...files].sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
          lastUploadElement.textContent = formatDate(sortedFiles[0].uploadedAt);
        };

        // --- LÓGICA DE LA APLICACIÓN ---
        const api = {
          getFiles: async (userId) => {
            const cacheKey = `files-${userId}`;
            const cachedData = sessionStorage.getItem(cacheKey);

            if (cachedData) {
              return JSON.parse(cachedData);
            }

            try {
              const response = await fetch(`/dashboard/utils/cdn/${userId}`);
              if (!response.ok) throw new Error('Network response was not ok');
              const data = await response.json();

              // Almacenar en caché por 1 minuto
              sessionStorage.setItem(cacheKey, JSON.stringify(data));
              setTimeout(() => sessionStorage.removeItem(cacheKey), 60000);

              return data;
            } catch (error) {
              console.error("API Error getFiles:", error);
              return { success: false, message: 'Error fetching files' };
            }
          },
          uploadFile: async (formData, onProgress) => {
            return new Promise(async (resolve) => {
              try {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (event) => {
                  if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    onProgress(percentComplete);
                  }
                });

                xhr.open('POST', `/dashboard/utils/cdn?userId=${USER_ID}`, true);

                xhr.onload = () => {
                  if (xhr.status >= 200 && xhr.status < 300) {
                    resolve(JSON.parse(xhr.responseText));
                  } else {
                    resolve({ success: false, message: 'Upload failed' });
                  }
                };

                xhr.onerror = () => {
                  resolve({ success: false, message: 'Network error' });
                };

                xhr.send(formData);
              } catch (error) {
                console.error("API Error uploadFile:", error);
                return { success: false, message: 'Error uploading file' };
              }
            });
          },
          deleteFile: async (userId, fileName) => {
            try {
              const response = await fetch(`/dashboard/utils/cdn/${userId}/${fileName}`, {
                method: 'DELETE'
              });
              if (!response.ok) throw new Error('Delete failed');
              return await response.json();
            } catch (error) {
              console.error("API Error deleteFile:", error);
              return { success: false, message: 'Error deleting file' };
            }
          }
        };

        const renderFileGrid = (files) => {
          fileGrid.innerHTML = '';
          currentFiles = files || [];
          updateUserStats(currentFiles);

          if (!files || files.length === 0) {
            noFilesMessage.classList.remove('d-none');
            return;
          }
          noFilesMessage.classList.add('d-none');

          files.forEach((file, index) => {
            const fileType = getFileType(file.mimeType);
            const preview = file.mimeType.startsWith('image/')
              ? `<img src="${file.downloadUrl}" alt="${file.title}" onerror="this.onerror=null;this.src='https://placehold.co/400/cccccc/ffffff?text=Error';">`
              : `<i class="${getFileIcon(file.mimeType)}"></i>`;

            const card = document.createElement('div');
            card.className = 'col-lg-3 col-md-4 col-sm-6 fade-in';
            card.style.animationDelay = `${index * 0.05}s`;
            card.innerHTML = `
        <div class="card file-card h-100" data-type="${fileType}" data-title="${file.title.toLowerCase()}" data-description="${(file.description || '').toLowerCase()}">
          <div class="file-preview position-relative">
            ${preview}
            <span class="file-type-badge">${getFileTypeName(file.mimeType)}</span>
          </div>
          <div class="card-body pb-0">
            <h5 class="card-title text-truncate">${file.title}</h5>
            <p class="card-text text-muted text-truncate">${file.description || file.originalName}</p>
          </div>
          <div class="card-footer">
            <p class="card-text text-muted mb-2">
              <small><strong data-key="uploadDate">${translations[currentLanguage].uploadDate}</strong>: ${formatDate(file.uploadedAt)}</small><br>
              <small><strong data-key="fileSize">${translations[currentLanguage].fileSize}</strong>: ${formatSize(file.size)}</small>
            </p>
            <div class="d-flex justify-content-between">
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary preview-btn" title="${translations[currentLanguage].previewBtn}">
                  <i class="fas fa-eye"></i>
                </button>
                <a href="/dashboard/utils/cdn/${USER_ID}/${file.fileName}" download="${file.originalName}" class="btn btn-sm btn-outline-secondary" title="${translations[currentLanguage].downloadBtn}">
                  <i class="fas fa-download"></i>
                </a>
              </div>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary share-btn" title="${translations[currentLanguage].shareBtn}">
                  <i class="fas fa-share-alt"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-btn" title="${translations[currentLanguage].deleteBtn}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

            card.querySelector('.preview-btn').addEventListener('click', () => handlePreview(file));
            card.querySelector('.share-btn').addEventListener('click', () => handleShare(file));
            card.querySelector('.delete-btn').addEventListener('click', () => handleDelete(file.fileName, card));
            fileGrid.appendChild(card);
          });

          // Initialize SortableJS for drag and drop reordering
          new Sortable(fileGrid, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function () {
              // You could save the new order to the server here
            }
          });
        };

        const filterFiles = () => {
          const searchTerm = searchInput.value.toLowerCase();
          const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;

          document.querySelectorAll('.file-card').forEach(card => {
            const title = (card.dataset.title || "");
            const description = (card.dataset.description || "");
            const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
            const matchesFilter = activeFilter === 'all' || card.dataset.type === activeFilter;

            card.parentElement.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
          });
        };

        const fetchAndRenderFiles = async () => {
          loadingSpinner.classList.remove('d-none');
          fileGrid.innerHTML = '';
          noFilesMessage.classList.add('d-none');

          try {
            // Forzar un pequeño retraso para asegurar que el DOM esté listo
            await new Promise(resolve => setTimeout(resolve, 50));

            const result = await api.getFiles(USER_ID);
            if (result.success) {
              renderFileGrid(result.data);

              // Agregar un pequeño retraso adicional para asegurar el renderizado
              setTimeout(() => {
                loadingSpinner.classList.add('d-none');
              }, 100);
            } else {
              showToast("Error", translations[currentLanguage].errorFetch, 'danger');
              loadingSpinner.classList.add('d-none');
              noFilesMessage.classList.remove('d-none');
            }
          } catch (error) {
            console.error("Error loading files:", error);
            loadingSpinner.classList.add('d-none');
            noFilesMessage.classList.remove('d-none');
            showToast("Error", translations[currentLanguage].errorFetch, 'danger');
          }
        };

        const renderSharedFileView = (params) => {
          try {
            if (!params || !params.get('title') || !params.get('url')) {
              throw new Error('Missing required parameters');
            }

            const title = decodeURIComponent(params.get('title'));
            const downloadUrl = decodeURIComponent(params.get('url'));
            const mimeType = decodeURIComponent(params.get('mime'));
            const size = params.get('size');
            const uploadedAt = decodeURIComponent(params.get('date'));

            const preview = mimeType.startsWith('image/')
              ? `<img src="${downloadUrl}" alt="${title}" class="img-fluid rounded-top" onerror="this.onerror=null;this.src='https://placehold.co/400/cccccc/ffffff?text=Error';">`
              : `<div class="file-preview" style="height:250px;"><i class="${getFileIcon(mimeType)} fa-5x"></i></div>`;

            const content = `
        ${preview}
        <div class="card-body text-center">
          <h3 class="card-title">${title}</h3>
          <p class="text-muted"><strong data-key="uploadDate">${translations[currentLanguage].uploadDate}</strong>: ${formatDate(uploadedAt)} | <strong data-key="fileSize">${translations[currentLanguage].fileSize}</strong>: ${formatSize(size)}</p>
          <a href="${downloadUrl}" class="btn btn-primary btn-lg mt-3" download>
            <i class="fas fa-download me-2"></i> <span data-key="downloadBtn">${translations[currentLanguage].downloadBtn}</span>
          </a>
        </div>
      `;
            document.getElementById('shared-file-content').innerHTML = content;
          } catch (error) {
            console.error("Error rendering shared file:", error);
            document.getElementById('shared-file-content').innerHTML = `
        <div class="alert alert-danger text-center">
          <h4>Error loading shared file</h4>
          <p>The shared link is invalid or incomplete.</p>
          <a href="/dashboard/cdn" class="btn btn-primary">Go to My Files</a>
        </div>
      `;
          }
        };

        const handlePreview = (file) => {
          const previewContent = document.getElementById('file-preview-content');

          if (file.mimeType.startsWith('image/')) {
            previewContent.innerHTML = `
        <img src="/dashboard/utils/cdn/view/${USER_ID}/${file.fileName}" class="img-fluid" style="max-height: 70vh; max-width: 100%; object-fit: contain;">
      `;
          } else if (file.mimeType.startsWith('video/')) {
            previewContent.innerHTML = `
        <video controls style="max-height: 70vh; max-width: 100%;">
          <source src="/dashboard/utils/cdn/view/${USER_ID}/${file.fileName}" type="${file.mimeType}">
          Your browser does not support the video tag.
        </video>
      `;
          } else if (file.mimeType.startsWith('audio/')) {
            previewContent.innerHTML = `
        <div class="text-center">
          <i class="${getFileIcon(file.mimeType)} fa-5x mb-4"></i>
          <audio controls style="width: 100%;">
            <source src="/dashboard/utils/cdn/view/${USER_ID}/${file.fileName}" type="${file.mimeType}">
            Your browser does not support the audio element.
          </audio>
          <h4 class="mt-3">${file.title}</h4>
        </div>
      `;
          } else if (file.mimeType === 'application/pdf') {
            previewContent.innerHTML = `
        <iframe src="/dashboard/utils/cdn/view/${USER_ID}/${file.fileName}" style="width: 100%; height: 70vh;" frameborder="0"></iframe>
      `;
          } else {
            previewContent.innerHTML = `
        <div class="text-center">
          <i class="${getFileIcon(file.mimeType)} fa-5x mb-3"></i>
          <h4>${file.title}</h4>
          <p>${file.description || ''}</p>
          <p class="text-muted">${formatSize(file.size)} | ${getFileTypeName(file.mimeType)}</p>
          <a href="/dashboard/utils/cdn/view/${USER_ID}/${file.fileName}" class="btn btn-primary" download>
            <i class="fas fa-download me-2"></i> ${translations[currentLanguage].downloadBtn}
          </a>
        </div>
      `;
          }

          filePreviewModal.show();
        };

        const handleUpload = async (e) => {
          e.preventDefault();
          const submitBtn = document.getElementById('submit-upload-btn');
          const spinner = submitBtn.querySelector('.spinner-border');

          const title = document.getElementById('fileTitle').value;
          const description = document.getElementById('fileDescription').value;
          const file = fileInput.files[0];

          if (!title || !file) {
            showToast("Error", "Title and file are required.", 'danger');
            return;
          }

          submitBtn.disabled = true;
          spinner.classList.remove('d-none');
          uploadProgress.style.display = 'block';

          try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('userId', USER_ID);
            formData.append('title', title);
            formData.append('description', description);

            const result = await api.uploadFile(formData, (progress) => {
              uploadProgressBar.style.width = `${progress}%`;
            });

            if (result.success) {
              // Avatar pulse animación al subir archivo
              if (userAvatar) {
                userAvatar.classList.remove('pulse');
                void userAvatar.offsetWidth; // trigger reflow
                userAvatar.classList.add('pulse');
              }
              showToast(
                translations[currentLanguage].uploadSuccess,
                translations[currentLanguage].uploadSuccess,
                'success'
              );
              uploadModal.hide();
              // Limpiar la caché para forzar recarga de archivos
              sessionStorage.removeItem(`files-${USER_ID}`);
              await fetchAndRenderFiles();
            } else {
              showToast(
                translations[currentLanguage].errorUpload,
                result.message || translations[currentLanguage].errorUpload,
                'danger'
              );
            }
          } catch (error) {
            console.error("Upload error:", error);
            showToast(
              translations[currentLanguage].errorUpload,
              error.message || translations[currentLanguage].errorUpload,
              'danger'
            );
          } finally {
            submitBtn.disabled = false;
            spinner.classList.add('d-none');
            uploadProgress.style.display = 'none';
            uploadProgressBar.style.width = '0%';
            uploadForm.reset();
            fileNameDisplay.textContent = '';
          }
        };

        const handleShare = (file) => {
          const shareUrl = `${window.location.origin}/dashboard/cdn/share?title=${encodeURIComponent(file.title)}&url=${encodeURIComponent(file.downloadUrl)}&mime=${encodeURIComponent(file.mimeType)}&size=${file.size}&date=${encodeURIComponent(file.uploadedAt)}`;

          navigator.clipboard.writeText(shareUrl).then(() => {
            showToast(
              translations[currentLanguage].copiedSuccess,
              translations[currentLanguage].copiedSuccess,
              'success'
            );
          }).catch(err => {
            console.error('Could not copy text: ', err);
            showToast(
              "Error",
              "Could not copy link to clipboard",
              'danger'
            );
          });
        };

        const handleDelete = async (fileName, cardElement) => {
          if (!confirm(translations[currentLanguage].deleteConfirm)) return;

          try {
            const result = await api.deleteFile(USER_ID, fileName);
            if (result.success) {
              showToast(
                translations[currentLanguage].deleteSuccess,
                translations[currentLanguage].deleteSuccess,
                'success'
              );
              cardElement.parentElement.remove();
              updateUserStats(currentFiles.filter(f => f.fileName !== fileName));
            } else {
              showToast(
                translations[currentLanguage].errorDelete,
                result.message || translations[currentLanguage].errorDelete,
                'danger'
              );
            }
          } catch (error) {
            console.error("Delete error:", error);
            showToast(
              translations[currentLanguage].errorDelete,
              error.message || translations[currentLanguage].errorDelete,
              'danger'
            );
          }
        };

        const updateTranslations = () => {
          document.querySelectorAll('[data-key]').forEach(element => {
            const key = element.dataset.key;
            if (translations[currentLanguage][key]) {
              if (element.tagName === 'INPUT' && element.placeholder) {
                element.placeholder = translations[currentLanguage][key];
              } else {
                element.textContent = translations[currentLanguage][key];
              }
            }
          });
        };

        // --- MANEJADORES DE EVENTOS ---

        if (themeSwitch) {
          themeSwitch.addEventListener('change', () => {
            const theme = themeSwitch.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            if (themeIcon) themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
          });
        }

        if (langLinks && langLinks.length) {
          langLinks.forEach(link => {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              currentLanguage = link.dataset.lang;
              localStorage.setItem('language', currentLanguage);
              updateTranslations();
              langLinks.forEach(l => l.classList.toggle('active', l === link));
            });
          });
        }

        if (dropZone) {
          dropZone.addEventListener('click', () => fileInput && fileInput.click());
          dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
          });
          dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
          });
          dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length && fileInput) {
              fileInput.files = e.dataTransfer.files;
              if (fileNameDisplay) fileNameDisplay.textContent = fileInput.files[0].name;
            }
          });
        }

        if (fileInput) {
          fileInput.addEventListener('change', () => {
            if (fileInput.files.length && fileNameDisplay) {
              fileNameDisplay.textContent = fileInput.files[0].name;
            }
          });
        }

        if (uploadForm) uploadForm.addEventListener('submit', handleUpload);
        if (searchInput) searchInput.addEventListener('input', filterFiles);

        if (filterButtons && filterButtons.length) {
          filterButtons.forEach(button => {
            button.addEventListener('click', () => {
              filterButtons.forEach(btn => btn.classList.remove('active'));
              button.classList.add('active');
              filterFiles();
            });
          });
        }

        if (refreshBtn) refreshBtn.addEventListener('click', fetchAndRenderFiles);

        // --- INICIALIZACIÓN ---
        const init = () => {
          const isSharedView = window.location.pathname.includes('/cdn/share') ||
            window.location.search.includes('share?title=');

          if (isSharedView) {
            if (mainView) mainView.style.display = 'none';
            if (sharedFileView) sharedFileView.style.display = 'block';

            // Asegurar que los parámetros existen antes de renderizar
            const params = new URLSearchParams(window.location.search);
            if (params.has('title') && params.has('url')) {
              renderSharedFileView(params);
              document.title = translations[currentLanguage].fileSharedTitle;
            } else {
              // Redirigir si faltan parámetros esenciales
              window.location.href = '/dashboard/cdn';
            }
          } else {
            if (mainView) mainView.style.display = 'block';
            if (sharedFileView) sharedFileView.style.display = 'none';
            setTimeout(fetchAndRenderFiles, 100);
          }

          // Set theme from localStorage or preference
          const savedTheme = localStorage.getItem('theme') ||
            'dark'; // Forzar dark por defecto
          document.documentElement.setAttribute('data-bs-theme', savedTheme);
          themeSwitch.checked = savedTheme === 'dark';
          themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
          // Set language from localStorage or browser
          const savedLanguage = localStorage.getItem('language') ||
            (navigator.language.startsWith('es') ? 'es' : 'en');
          currentLanguage = savedLanguage;
          document.querySelector(`.lang-link[data-lang="${savedLanguage}"]`).classList.add('active');
          updateTranslations();
        };

        // Iniciar después de un pequeño retraso para asegurar que el DOM esté completamente cargado
        setTimeout(init, 50);
      });
    </script>
</body>

</html>