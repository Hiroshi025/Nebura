generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["metrics"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//******************* API MODELS ********************//

model UserAPI {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String   @unique
  password  String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  blockedIPs BlockedIP[] @relation("BlockedUserRelation")
  bans       BanUser[]   @relation("UserBans")
  tasks      Task[]      @relation("UserTasks")
}

model License {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  key          String
  type         LicenseType
  userId       String
  adminId      String
  hwid         String[]
  requestLimit Int         @default(1000)
  requestCount Int         @default(0)
  validUntil   DateTime
  lastUsedIp   String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model BlockedIP {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  ipAddress   String    @unique
  blockedUser UserAPI   @relation("BlockedUserRelation", fields: [blockedBy], references: [id])
  blockedBy   String    @db.ObjectId
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  reason      String?
  isActive    Boolean   @default(true)
}

model FailedAttempt {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  ipAddress   String
  attemptTime DateTime @default(now())
  userAgent   String?
  licenseKey  String?

  @@index([ipAddress])
  @@index([attemptTime])
}

model RateLimitViolation {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  ipAddress     String
  endpoint      String
  violationTime DateTime @default(now())

  @@index([ipAddress])
  @@index([violationTime])
}

//******************* END API MODELS ******************//

//******************* TASK MODELS ********************//

model Task {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  dueDate     DateTime? @map("due_date")
  status      String    @default("pending")
  priority    String    @default("medium")
  tags        String[]
  reminder    Json?
  recurrence  Json?
  autoDelete  DateTime? @map("auto_delete")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")
  UserAPI     UserAPI?  @relation("UserTasks", fields: [userAPIId], references: [id])
  userAPIId   String?   @db.ObjectId

  @@map("tasks")
}

//******************* END TASK MODELS ******************//

//******************* WHATSAPP MODELS *****************//

model WhatsApp {
  id        String   @id @default(cuid()) @map("_id") @db.ObjectId
  session   String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//******************* END WHATSAPP MODELS ************//

//******************* DISCORD MODELS ****************//

model MyDiscord {
  id           String   @id @default(cuid()) @map("_id") @db.ObjectId
  clientId     String   @unique
  clientSecret String
  token        String   @unique
  logconsole   Boolean  @default(false)
  errorlog     Boolean  @default(false)
  webhookURL   String?
  logchannel   String?
  owners       String[] @default([])
  createdAt    DateTime @default(now())
}

model MyGuild {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  guildId   String  @unique
  prefix    String? @default("!")
  discordId String
  rooms     String?

  reminders Reminder[]
  warns     UserWarn[]
  bans      BanUser[]

  eventlogs EventLogs?
  economy   Economy?
  captcha   Captcha?

  membercount_channel1 String?
  membercount_message1 String?
  membercount_channel2 String?
  membercount_message2 String?
  membercount_channel3 String?
  membercount_message3 String?
  membercount_channel4 String?
  membercount_message4 String?
  membercount_channel5 String?
  membercount_message5 String?

  suggestChannel String?
  embedColor     String?
  footerText     String?
  approveEmoji   String?
  denyEmoji      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BanUser {
  id            String       @id @default(cuid()) @map("_id")
  guildId       String       @db.ObjectId
  guild         MyGuild      @relation(fields: [guildId], references: [id])
  userId        String       @db.ObjectId
  user          UserAPI      @relation("UserBans", fields: [userId], references: [id])
  userDiscordId String?      @db.ObjectId
  userDiscord   UserDiscord? @relation(fields: [userDiscordId], references: [id])
  banReason     String?
  banTime       DateTime?
  createdAt     DateTime     @default(now())
}

model UserWarn {
  id         String       @id @default(auto()) @map("_id") @db.ObjectId
  guildId    String       @db.ObjectId
  guild      MyGuild      @relation(fields: [guildId], references: [id])
  userId     String       @db.ObjectId
  user       UserDiscord? @relation(fields: [userId], references: [id])
  warnReason String
  warnDate   String
  moderator  String
}

model ServerModlog {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  guildId   String  @unique @db.ObjectId
  channelId String

  @@map("serverModlogs")
}

model Reminder {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String
  guildId   String   @db.ObjectId
  guild     MyGuild  @relation(fields: [guildId], references: [id])
  message   String
  remindAt  DateTime
  createdAt DateTime @default(now())
  isSent    Boolean  @default(false)

  @@index([remindAt])
}

//******************* ECONOMY MODELS ******************//

model Economy {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  guildId        String  @unique @db.ObjectId
  guild          MyGuild @relation(fields: [guildId], references: [id])
  currencyName   String
  currencyEmoji  String
  currencyPerMsg String
}

model UserInventory {
  id              String @id @default(auto()) @map("_id") @db.ObjectId
  guildId         String
  userId          String
  itemIdentifier  String
  itemName        String
  itemDescription String
  itemPrice       String
  role            String
  money           Float
}

model ShopEconomy {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  guildId String

  itemName        String
  itemDescription String
  itemPrice       String
  itemIdentifier  String @unique

  role  String
  money Float
}

model UserEconomy {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  guildId      String
  userId       String
  messageCount Int?   @default(0)

  balance   Float @default(0)
  lostduels Int?  @default(0)
  wonduels  Int?  @default(0)

  userId_guildId String @unique(map: "userId_guildId")

  job          String?
  jobStartDate DateTime?
  lastWorkDate DateTime?
  jobCooldown  DateTime?

  // NEW FIELDS
  jobRank    Int?  @default(1)
  skills     Json? // { jobName: level }
  reputation Int?  @default(0)
  prestige   Int?  @default(0)
}

model UserLoan {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  userId   String
  guildId  String
  amount   Float
  interest Float
  takenAt  DateTime @default(now())
  dueDate  DateTime
  paid     Boolean  @default(false)
}

//******************* END ECONOMY MODELS ******************//

model UserDiscord {
  id     String     @id @default(auto()) @map("_id") @db.ObjectId
  userId String     @unique
  guilds Int?       @default(0)
  warns  UserWarn[]
  bans   BanUser[]
}

//******************* DISCORD LEVEL MODELS **************//

model LevelConfig {
  id             String  @id @default(cuid()) @map("_id")
  guildId        String  @unique
  channelId      String?
  status         Boolean
  bonusChannels  Json? // Array of { channelId: String, multiplier: Number }
  maxLevel       Int     @default(100)
  weeklyRewards  Json? // <-- agrega esto
  monthlyRewards Json? // <-- y esto/*  */
}

model UserLevel {
  id            String    @id @default(cuid()) @map("_id")
  guildId       String
  userId        String
  xp            Int
  level         Int
  prestige      Int       @default(0)
  weeklyXp      Int       @default(0)
  monthlyXp     Int       @default(0)
  totalMessages Int       @default(0)
  lastActive    DateTime?
  background    String?
  barColor      String?
  borderColor   String?
  blur          Int?

  streaks         Streak?
  quests          UserQuests?       @relation("UserLevelQuests")
  achievements    UserAchievements? @relation("UserLevelAchievements")
  prestigeHistory PrestigeHistory[] @relation("UserLevelToPrestigeHistory")

  @@unique([guildId, userId])
}

model Streak {
  id            String @id @default(cuid()) @map("_id")
  userId        String
  guildId       String
  lastActive    String // YYYY-MM-DD
  currentStreak Int    @default(1)
  longestStreak Int    @default(1)

  userLevel UserLevel? @relation(fields: [userId, guildId], references: [userId, guildId])

  @@unique([userId, guildId])
}

model UserQuests {
  id              String @id @default(cuid()) @map("_id")
  userId          String
  guildId         String
  dailyProgress   Json // { questId: progress }
  dailyCompleted  Json // { questId: boolean }
  weeklyProgress  Json
  weeklyCompleted Json

  userLevel UserLevel? @relation("UserLevelQuests", fields: [userId, guildId], references: [userId, guildId])

  @@unique([userId, guildId])
}

model UserAchievements {
  id           String   @id @default(cuid()) @map("_id")
  userId       String
  guildId      String
  achievements String[] // Array of achievement IDs

  userLevel UserLevel? @relation("UserLevelAchievements", fields: [userId, guildId], references: [userId, guildId])

  @@unique([userId, guildId])
}

model PrestigeHistory {
  id            String   @id @default(cuid()) @map("_id")
  userId        String
  guildId       String
  date          DateTime
  levelAchieved Int

  userLevel UserLevel @relation("UserLevelToPrestigeHistory", fields: [userId, guildId], references: [userId, guildId])

  @@index([userId, guildId])
}

model WeeklyLeaderboard {
  id        String   @id @default(cuid()) @map("_id")
  guildId   String
  week      Int // Week number of the year
  data      Json // Top users data
  createdAt DateTime @default(now())

  @@unique([guildId, week])
}

model MonthlyLeaderboard {
  id        String   @id @default(cuid()) @map("_id")
  guildId   String
  month     Int // 1-12
  year      Int
  data      Json // Top users data
  createdAt DateTime @default(now())

  @@unique([guildId, month, year])
}

model LeaderboardReset {
  id        String @id @default(cuid()) @map("_id")
  guildId   String @unique
  lastWeek  Int
  lastMonth Int
}

//******************* END DISCORD LEVEL MODELS **************//

model Captcha {
  id        String  @id @map("_id") @db.ObjectId
  isEnabled Boolean @default(false)
  role      String
  guild     MyGuild @relation(fields: [id], references: [id])
}

model Suggestion {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  suggestId  String
  messageId  String   @unique
  content    String
  imageUrl   String?
  upvotes    Int      @default(0)
  downvotes  Int      @default(0)
  voters     String[] @default([]) // Array of user IDs who upvoted
  downvoters String[] @default([]) // Array of user IDs who downvoted
  authorId   String
  guildId    String
  status     String
  lastVoter  String?
  resolvedBy String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime? @map("resolved_at")
}

model ReactionRole {
  id           String   @id @default(cuid()) @map("_id")
  guildId      String
  messageId    String
  removeOthers Boolean
  parameters   Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([guildId])
  @@index([messageId])
}

model Metrics {
  id                       String   @id @default(auto()) @map("_id") @db.ObjectId
  endpoint_clientId_system String   @unique
  endpoint                 String
  clientId                 String?
  system                   String
  requests                 Int      @default(0)
  errors                   Int      @default(0)
  latency                  Float    @default(0.0) // Promedio de latencia en ms
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@index([endpoint, clientId, system])
}

model FileMetadata {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String
  originalName String
  fileName     String
  title        String
  description  String?
  uploadedAt   DateTime @default(now())
  uploadedBy   String
  path         String
  size         Int
  mimeType     String
  downloadUrl  String

  @@map("file_metadata")
}

model sharedLinkCDN {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  fileId       String
  url          String
  expiresAt    DateTime? // Puede ser null si no expira
  maxDownloads Int? // Puede ser null si no hay límite
  downloads    Int       @default(0)
  password     String? // Puede ser null si no tiene contraseña
}

type EventLogs {
  enabled   Boolean
  channelId String?
  events    String[]
}

//******************* END DISCORD MODELS **************//

//******************* LICENSE ENUMS *******************//

enum LicenseType {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
  CUSTOM
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  BANNED
  REVOKED
}

//******************* END LICENSE ENUMS *****************//
