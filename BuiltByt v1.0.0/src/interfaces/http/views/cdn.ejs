<!DOCTYPE html>
<html lang="es" data-bs-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Nebura CDN: Sube, comparte y gestiona archivos de forma segura y sencilla en la nube de Nebura Works.">
  <meta name="keywords"
    content="Nebura, CDN, archivos, compartir, nube, almacenamiento, upload, download, gestión, plataforma, seguridad">
  <meta name="author" content="Nebura">
  <meta property="og:title"
    content="<%= sharedFile ? sharedFile.title : 'Nebura CDN - Gestión y Compartición de Archivos' %>">
  <meta property="og:description"
    content="<%= sharedFile ? (sharedFile.description || 'Archivo compartido en Nebura CDN') : 'Sube, comparte y gestiona archivos fácilmente en la nube de Nebura Works.' %>">
  <% if (sharedFile && sharedFile.mimeType && sharedFile.mimeType.startsWith('image/')) { %>
    <meta property="og:image" content="<%= sharedFile.downloadUrl %>">
    <% } %>
      <meta property="og:type" content="website">
      <meta property="og:url"
        content="<%= sharedFile ? sharedFile.shareUrl : 'https://host.hiroshi-dev.me/dashboard/cdn' %>">
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:title" content="Nebura CDN - Gestión y Compartición de Archivos">
      <meta name="twitter:description"
        content="Sube, comparte y gestiona archivos fácilmente en la nube de Nebura Works. Acceso rápido y seguro a tus documentos.">

      <title>
        <%= title %>
      </title>

      <!-- Link Utils -->
      <%- include('partials/link', { user: user }) %>
        <link rel="stylesheet" href="/css/cdn.css">
        <script>
          window.USER_ID = JSON.parse('<%- JSON.stringify(user.id) %>');
          window.USER_DATA = JSON.parse('<%- JSON.stringify(user) %>');
        </script>
</head>

<body style="background: var(--bs-body-bg); color: var(--bs-body-color);">
  <div id="app-container">
    <div class="d-flex" style="min-height: 100vh;">
      <!-- SIDEBAR MEJORADO -->
      <%- include('partials/sidebar', { user: user }) %>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="flex-grow-1 p-4" style="background: var(--bs-body-bg); color: var(--bs-body-color);">
          <% if (!sharedFile) { %>
            <!-- Sección de usuario y grid de archivos -->
            <!-- User Profile Section -->
            <div id="user-profile-section" class="user-profile animate__animated animate__fadeIn">
              <div class="d-flex align-items-center">
                <img
                  src="<%= user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=256` : 'https://imgs.search.brave.com/4rnnJU7_ENkK60goDh2C1fAWVhiD56t5CXuDp6Bs92o/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9jZG4u/cGl4YWJheS5jb20v/cGhvdG8vMjAxMy8w/Ny8xMy8xMC80NC9t/YW4tMTU3Njk5XzY0/MC5wbmc' %>"
                  alt="User Avatar" class="user-avatar me-3">
                <div>
                  <h3 class="mb-0"><%- user.global_name || user.username || user.name %></h3>
                  <p class="mb-0 opacity-75">
                    <% if (user.username) { %>
                      @<%- user.username %>
                        <% } else { %>
                          Role: <%- user.role %>
                            <% } %>
                  </p>
                  <div class="d-flex mt-2">
                    <span class="badge bg-primary me-2">
                      <i class="fas fa-crown me-1"></i> <%- user.premium_type ? (user.premium_type===2 ? 'Nitro'
                        : 'Basic' ) : 'Sin Suscripción' %>
                    </span>
                    <span class="badge bg-secondary">
                      <i class="fas fa-users me-1"></i> <%- user.guilds ? user.guilds.length : 0 %> <span
                          data-key="guildsCount">Servidores</span>
                    </span>
                  </div>
                </div>
              </div>
              <div class="user-stats">
                <div class="stat-item">
                  <div class="stat-value" id="total-files">0</div>
                  <div class="stat-label" data-key="totalFiles">Archivos Totales</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="total-size">0 MB</div>
                  <div class="stat-label" data-key="totalSize">Tamaño Total</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="last-upload">-</div>
                  <div class="stat-label" data-key="lastUpload">Última Subida</div>
                </div>
              </div>
            </div>

            <!-- VISTA PRINCIPAL (GRID DE ARCHIVOS) -->
            <div id="main-view">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 fw-bold" data-key="mainTitle">Mis Archivos</h1>
                <div>
                  <button class="btn btn-secondary me-2" id="toggle-view-btn" title="Cambiar vista">
                    <i class="fas fa-th"></i>
                  </button>
                  <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-upload me-2"></i><span data-key="uploadBtn">Subir Archivo</span>
                  </button>
                  <button class="btn btn-outline-primary" id="refresh-btn" title="Recargar">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
              </div>

              <!-- Barra de progreso global -->
              <div id="global-progress-container" class="upload-progress mb-3" style="display:none;">
                <div id="global-progress-bar" class="upload-progress-bar"></div>
              </div>

              <!-- Acciones en lote -->
              <div id="batch-actions" class="mb-3 d-none">
                <button class="btn btn-outline-danger btn-sm" id="batch-delete-btn" data-key="batchDeleteBtn"><i
                    class="fas fa-trash"></i> Eliminar
                  seleccionados</button>
                <button class="btn btn-outline-primary btn-sm" id="batch-download-btn" data-key="batchDownloadBtn"><i
                    class="fas fa-download"></i>
                  Descargar seleccionados</button>
                <span id="selected-count" class="ms-2"></span>
              </div>

              <!-- Search and Filter Section -->
              <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="form-control search-input" id="search-input" placeholder="Buscar archivos..."
                  data-key="searchPlaceholder"
                  style="background: var(--input-bg-dark); color: var(--bs-body-color); border: 1px solid var(--input-border-dark);">
              </div>

              <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" data-key="filterAll">Todos</button>
                <button class="filter-btn" data-filter="image" data-key="filterImages">Imágenes</button>
                <button class="filter-btn" data-filter="video" data-key="filterVideos">Videos</button>
                <button class="filter-btn" data-filter="audio" data-key="filterAudio">Audio</button>
                <button class="filter-btn" data-filter="document" data-key="filterDocuments">Documentos</button>
                <button class="filter-btn" data-filter="other" data-key="filterOther">Otros</button>
              </div>

              <!-- Vista GRID -->
              <div id="file-grid" class="row g-4">
                <!-- Las tarjetas de archivos se insertarán aquí -->
              </div>
              <!-- Vista LISTA -->
              <div id="file-list" class="table-responsive d-none">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th><input type="checkbox" id="select-all-files"></th>
                      <th data-key="fileType">Tipo</th>
                      <th data-key="fileTitleLabel">Título</th>
                      <th data-key="fileDescriptionLabel">Descripción</th>
                      <th data-key="uploadDate">Subido el</th>
                      <th data-key="fileSize">Tamaño</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="file-list-body">
                    <!-- Filas de archivos -->
                  </tbody>
                </table>
              </div>

              <!-- Paginación -->
              <nav id="pagination-nav" class="mt-3 d-flex justify-content-center d-none">
                <ul class="pagination mb-0">
                  <li class="page-item"><button class="page-link" id="prev-page-btn">&laquo;</button></li>
                  <li class="page-item disabled"><span class="page-link" id="page-info"></span></li>
                  <li class="page-item"><button class="page-link" id="next-page-btn">&raquo;</button></li>
                </ul>
              </nav>

              <div id="loading-spinner" class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
              </div>
              <div id="no-files-message" class="text-center text-muted my-5 d-none">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                <h4 data-key="noFilesTitle">No hay archivos todavía</h4>
                <p data-key="noFilesSubtitle">¡Sube tu primer archivo para empezar!</p>
              </div>
            </div>
            <% } %>

              <% if (sharedFile) { %>
                <!-- Solo mostrar la vista de archivo compartido -->
                <div id="shared-file-view" style="display:block;">
                  <div class="d-flex justify-content-center">
                    <div class="card file-card" style="max-width: 800px; width: 100%;">
                      <div id="shared-file-content">
                        <!-- El contenido del archivo compartido se insertará aquí por JS -->
                      </div>
                    </div>
                  </div>
                </div>
                <% } %>
        </main>
    </div>

    <!-- Modal de Subida -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title fw-bold" id="uploadModalLabel" data-key="modalTitle">Subir Nuevo Archivo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="uploadForm">
              <div class="mb-3">
                <label for="fileTitle" class="form-label" data-key="fileTitleLabel">Título del Archivo</label>
                <input type="text" class="form-control" id="fileTitle" required
                  style="background: var(--input-bg-dark); color: var(--bs-body-color); border: 1px solid var(--input-border-dark);">
              </div>
              <div class="mb-3">
                <label for="fileDescription" class="form-label" data-key="fileDescriptionLabel">Descripción
                  (Opcional)</label>
                <textarea class="form-control" id="fileDescription" rows="2"
                  style="background: var(--input-bg-dark); color: var(--bs-body-color); border: 1px solid var(--input-border-dark);"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label" data-key="fileSelectLabel">Archivo</label>
                <div id="drop-zone" class="drop-zone">
                  <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                  <p class="mb-0" data-key="dropZoneText">Arrastra y suelta un archivo aquí o haz clic para
                    seleccionar
                  </p>
                  <small id="file-name-display" class="text-primary"></small>
                  <div class="upload-progress mt-2">
                    <div class="upload-progress-bar"></div>
                  </div>
                </div>
                <input type="file" id="fileInput" class="d-none" required name="file">
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary" id="submit-upload-btn">
                  <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                  <span data-key="modalUploadBtn">Subir Archivo</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- File Preview Modal -->
    <div class="modal fade file-preview-modal" id="filePreviewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="modal-body p-0">
            <div id="file-preview-content" class="w-100 h-100 d-flex justify-content-center align-items-center">
              <!-- Preview content will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Compartir Archivo -->
    <div class="modal fade" id="shareFileModal" tabindex="-1" aria-labelledby="shareFileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title fw-bold" id="shareFileModalLabel" data-key="shareModalTitle">Compartir Archivo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="share-file-preview" class="mb-3"></div>
            <div class="mb-2">
              <label class="form-label fw-semibold" data-key="shareFileNameLabel">Archivo:</label>
              <span id="share-file-title"></span>
            </div>
            <div class="mb-2">
              <label class="form-label fw-semibold" data-key="shareFileDescLabel">Descripción:</label>
              <span id="share-file-desc"></span>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold" data-key="shareLinkLabel">Enlace para compartir:</label>
              <div class="input-group">
                <input type="text" class="form-control" id="share-file-link" readonly
                  style="background: var(--input-bg-dark); color: var(--bs-body-color); border: 1px solid var(--input-border-dark);">
                <button class="btn btn-outline-primary" type="button" id="copy-share-link-btn" data-key="copyLinkBtn">
                  Copiar
                </button>
              </div>
              <div id="share-link-copied" class="text-success mt-2 d-none" data-key="copiedSuccess">
                ¡Enlace copiado al portapapeles!
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast para notificaciones -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto" id="toast-title"></strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="/scripts/cdn/index.js"></script>
</body>

</html>