<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%- title %></title>
  <meta name="description"
    content="Panel de administración de soporte de Nebura - Gestiona tickets, estadísticas y transcripciones">
  <meta name="keywords" content="Nebura, Soporte, Admin, Tickets, Estadísticas">
  <meta name="author" content="Nebura">

  <!-- Favicon y Open Graph -->
  <link rel="icon" href="/favicon.ico">
  <meta property="og:title" content="Panel de Administración de Soporte Nebura">
  <meta property="og:description" content="Panel de administración para gestionar el sistema de soporte de Nebura">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://host.hiroshi-dev.me/admin/support">
  <meta name="twitter:card" content="summary_large_image">

  <!-- CSS -->
  <%- include('partials/link', { user: user }) %>
    <link rel="stylesheet" href="/css/support.css">
    <link rel="stylesheet" href="/css/tickets.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Definir user globalmente para todos los scripts
      window.adminUser = JSON.parse('<%- JSON.stringify(user) %>');
      window.webURL = JSON.parse('<%- JSON.stringify(webURL) %>');
      window.user = JSON.parse('<%- JSON.stringify(user) %>');
      window.currentAdminTicketId = null;
    </script>
</head>

<body class="loaded" style="background: var(--background-color-dark); color: var(--text-color-dark);">
  <div id="app-container">
    <div class="d-flex" style="min-height: 100vh;">
      <%- include('partials/sidebar', { user: user, panelSection: ` <div class='sidebar-section-title'>
        <i class="fas fa-headset me-2"></i><span data-key="supportAdminTitle">Soporte Admin</span>
    </div>
    <div class='sidebar-divider'></div>
    <a href="#tickets-admin" class="sidebar-link" data-bs-toggle="tab" data-bs-target="#tickets-admin-pane">
      <i class="fas fa-ticket-alt me-2"></i><span data-key="ticketsTab">Tickets</span>
    </a>
    <a href="#stats-admin" class="sidebar-link" data-bs-toggle="tab" data-bs-target="#stats-admin-pane">
      <i class="fas fa-chart-bar me-2"></i><span data-key="statsTab">Estadísticas</span>
    </a>
    <a href="#transcripts-admin" class="sidebar-link" data-bs-toggle="tab" data-bs-target="#transcripts-admin-pane">
      <i class="fas fa-file-alt me-2"></i><span data-key="transcriptsTab">Transcripciones</span>
    </a>
    ` }) %>

    <main class="flex-grow-1 p-4" style="background: var(--background-color-dark); color: var(--text-color-dark);">
      <!-- Tabs principales -->
      <ul class="nav nav-tabs mb-4" id="adminSupportTabs" role="tablist"
        style="border-bottom: 1px solid var(--border-color-dark);">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tickets-admin-tab" data-bs-toggle="tab"
            data-bs-target="#tickets-admin-pane" type="button" role="tab" aria-controls="tickets-admin-pane"
            aria-selected="true">
            <i class="fas fa-ticket-alt me-2"></i><span data-key="ticketsTab">Tickets</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="stats-admin-tab" data-bs-toggle="tab" data-bs-target="#stats-admin-pane"
            type="button" role="tab" aria-controls="stats-admin-pane" aria-selected="false">
            <i class="fas fa-chart-bar me-2"></i><span data-key="statsTab">Estadísticas</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="transcripts-admin-tab" data-bs-toggle="tab"
            data-bs-target="#transcripts-admin-pane" type="button" role="tab" aria-controls="transcripts-admin-pane"
            aria-selected="false">
            <i class="fas fa-file-alt me-2"></i><span data-key="transcriptsTab">Transcripciones</span>
          </button>
        </li>
      </ul>

      <div class="tab-content" id="adminSupportTabsContent">
        <!-- Tickets Tab -->
        <div class="tab-pane fade show active" id="tickets-admin-pane" role="tabpanel"
          aria-labelledby="tickets-admin-tab" tabindex="0">
          <!-- Filtros y búsqueda -->
          <div class="card mb-4" style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
            <div class="card-body py-2">
              <div class="d-flex flex-wrap align-items-center gap-2">
                <select id="admin-ticket-filter" class="form-select form-select-sm"
                  style="width: 150px; background: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
                  <option value="all" data-key="filterAll">Todos</option>
                  <option value="OPEN" data-key="filterOpen">Abiertos</option>
                  <option value="PENDING" data-key="filterPending">Pendientes</option>
                  <option value="CLOSED" data-key="filterClosed">Cerrados</option>
                </select>
                <div class="input-group input-group-sm" style="width: 200px;">
                  <span class="input-group-text"
                    style="background: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);"><i
                      class="fas fa-search"></i></span>
                  <input type="text" class="form-control" placeholder="Buscar tickets..." id="admin-ticket-search"
                    data-key="searchTicketsPlaceholder"
                    style="background: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
                </div>
                <button class="btn btn-sm btn-outline-secondary ms-auto" id="admin-refresh-tickets" title="Recargar">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Lista de tickets -->
          <div class="card" style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="admin-tickets-table"
                  style="background: transparent; color: var(--text-color-dark);">
                  <thead>
                    <tr>
                      <th data-key="ticketId">ID</th>
                      <th data-key="user">Usuario</th>
                      <th data-key="subject">Asunto</th>
                      <th data-key="status">Estado</th>
                      <th data-key="assignedTo">Asignado a</th>
                      <th data-key="date">Fecha</th>
                      <th data-key="actions">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="admin-tickets-list">
                    <!-- Tickets se cargarán aquí -->
                    <tr>
                      <td colspan="7" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden" data-key="loading">Cargando...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Paginación -->
          <nav class="mt-3">
            <ul class="pagination justify-content-center" id="admin-tickets-pagination">
              <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" data-key="previous">Anterior</a>
              </li>
              <li class="page-item active"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#" data-key="next">Siguiente</a>
              </li>
            </ul>
          </nav>
        </div>

        <!-- Estadísticas Tab -->
        <div class="tab-pane fade" id="stats-admin-pane" role="tabpanel" aria-labelledby="stats-admin-tab" tabindex="0">
          <div class="animate__animated animate__fadeIn">
            <div class="row">
              <!-- Estadísticas generales -->
              <div class="col-md-6">
                <div class="stats-card"
                  style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
                  <h5><i class="fas fa-chart-pie me-2"></i> Resumen de Tickets</h5>
                  <div class="chart-container">
                    <canvas id="tickets-summary-chart"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="stats-card"
                  style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
                  <h5><i class="fas fa-calendar-alt me-2"></i> Tickets por Mes</h5>
                  <div class="chart-container">
                    <canvas id="tickets-monthly-chart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="stats-card"
                  style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
                  <h5><i class="fas fa-tags me-2"></i> Tickets por Categoría</h5>
                  <div class="chart-container">
                    <canvas id="tickets-category-chart"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="stats-card"
                  style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
                  <h5><i class="fas fa-trophy me-2"></i> Top Usuarios</h5>
                  <div class="table-responsive">
                    <table class="table table-sm" style="background: transparent; color: var(--text-color-dark);">
                      <thead>
                        <tr>
                          <th data-key="user">Usuario</th>
                          <th data-key="tickets">Tickets</th>
                          <th data-key="lastActivity">Última actividad</th>
                        </tr>
                      </thead>
                      <tbody id="top-users-list">
                        <!-- Top usuarios se cargará aquí -->
                        <tr>
                          <td colspan="3" class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                              <span class="visually-hidden">Cargando...</span>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Transcripciones Tab -->
        <div class="tab-pane fade" id="transcripts-admin-pane" role="tabpanel" aria-labelledby="transcripts-admin-tab"
          tabindex="0">
          <div class="animate__animated animate__fadeIn">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3 class="h4 fw-bold">
                <i class="fas fa-file-alt me-2"></i><span data-key="transcriptsAdminTitle">Todas las
                  Transcripciones</span>
              </h3>
              <div class="d-flex align-items-center gap-2">
                <select id="admin-transcript-filter" class="form-select form-select-sm"
                  style="width: 150px; background: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
                  <option value="all" data-key="filterAll">Todos</option>
                  <option value="ticket" data-key="filterTicket">Tickets</option>
                  <option value="chat" data-key="filterChat">Chats</option>
                </select>
                <button class="btn btn-sm btn-outline-secondary" id="admin-refresh-transcripts" title="Recargar">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
            </div>

            <div class="card" style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover mb-0" id="admin-transcripts-table"
                    style="background: transparent; color: var(--text-color-dark);">
                    <thead>
                      <tr>
                        <th data-key="transcriptId">ID</th>
                        <th data-key="type">Tipo</th>
                        <th data-key="referenceId">Referencia</th>
                        <th data-key="participants">Participantes</th>
                        <th data-key="date">Fecha</th>
                        <th data-key="duration">Duración</th>
                        <th data-key="actions">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="admin-transcripts-list">
                      <!-- Transcripciones se cargarán aquí -->
                      <tr>
                        <td colspan="7" class="text-center py-4">
                          <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden" data-key="loading">Cargando...</span>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Paginación -->
            <nav class="mt-3">
              <ul class="pagination justify-content-center" id="admin-transcripts-pagination">
                <li class="page-item disabled">
                  <a class="page-link" href="#" tabindex="-1" data-key="previous">Anterior</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                  <a class="page-link" href="#" data-key="next">Siguiente</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </main>
  </div>
  </div>

  <!-- Modal Chat Ticket Admin -->
  <div class="modal fade" id="adminTicketChatModal" tabindex="-1" aria-labelledby="adminTicketChatModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adminTicketChatModalLabel">
            <i class="fas fa-ticket-alt me-2"></i><span data-key="ticketNumber">Ticket #</span><span
              id="admin-ticket-id-placeholder"></span>
          </h5>
          <div class="d-flex align-items-center">
            <span class="badge bg-primary me-2" id="admin-ticket-status-badge" data-key="openStatus">Abierto</span>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>
        <div class="modal-body p-0">
          <div class="ticket-chat-container">
            <div class="ticket-info-sidebar">
              <div class="ticket-info-header">
                <h6 data-key="ticketInfo">Información del Ticket</h6>
              </div>
              <div class="ticket-info-content">
                <div class="info-item">
                  <span class="info-label" data-key="userLabel">Usuario:</span>
                  <span class="info-value" id="admin-ticket-user-info">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label" data-key="createdLabel">Creado:</span>
                  <span class="info-value" id="admin-ticket-created-at">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label" data-key="updatedLabel">Actualizado:</span>
                  <span class="info-value" id="admin-ticket-updated-at">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label" data-key="categoryLabel">Categoría:</span>
                  <span class="info-value" id="admin-ticket-category-info">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label" data-key="priorityLabel">Prioridad:</span>
                  <span class="info-value" id="admin-ticket-priority-info">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label" data-key="subjectLabel">Asunto:</span>
                  <span class="info-value" id="admin-ticket-subject-info">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label" data-key="assignedToLabel">Asignado a:</span>
                  <span class="info-value" id="admin-ticket-assigned-info">-</span>
                </div>
              </div>
              <div class="ticket-actions">
                <select class="form-select form-select-sm mb-2" id="admin-assign-to">
                  <option value="" selected disabled data-key="assignToPlaceholder">Asignar a...</option>
                  <!-- Admins se cargarán aquí -->
                </select>
                <button class="btn btn-sm btn-outline-danger w-100" id="admin-close-ticket-btn">
                  <i class="fas fa-times-circle me-1"></i><span data-key="closeTicketBtn">Cerrar Ticket</span>
                </button>
              </div>
            </div>
            <div class="ticket-chat-main">
              <div class="ticket-chat-messages" id="admin-ticket-chat-messages">
                <!-- Mensajes del ticket se cargarán aquí -->
              </div>
              <div class="ticket-chat-input-container">
                <div class="ticket-chat-tools">
                  <button class="btn btn-sm btn-outline-secondary" title="Adjuntar archivo">
                    <i class="fas fa-paperclip"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" title="Insertar código">
                    <i class="fas fa-code"></i>
                  </button>
                </div>
                <textarea class="form-control ticket-chat-input" id="admin-ticket-chat-input"
                  placeholder="Escribe tu respuesta..." rows="2" data-key="writeReplyPlaceholder"></textarea>
                <button class="btn btn-primary ticket-chat-send" id="admin-send-ticket-msg-btn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Transcripción Admin -->
  <div class="modal fade" id="adminTranscriptModal" tabindex="-1" aria-labelledby="adminTranscriptModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adminTranscriptModalLabel">
            <i class="fas fa-file-alt me-2"></i><span data-key="transcriptNumber">Transcripción #</span><span
              id="admin-transcript-id-placeholder"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="transcript-info mb-4">
            <div class="row">
              <div class="col-md-6">
                <div class="info-item">
                  <span class="info-label" data-key="typeLabel">Tipo:</span>
                  <span class="info-value" id="admin-transcript-type">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label" data-key="referenceLabel">Referencia:</span>
                  <span class="info-value" id="admin-transcript-reference">-</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <span class="info-label" data-key="dateLabel">Fecha:</span>
                  <span class="info-value" id="admin-transcript-date">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label" data-key="durationLabel">Duración:</span>
                  <span class="info-value" id="admin-transcript-duration">-</span>
                </div>
              </div>
            </div>
          </div>
          <div class="transcript-content card">
            <div class="card-body" id="admin-transcript-content">
              <!-- Contenido de la transcripción se cargará aquí -->
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden" data-key="loading">Cargando...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-key="closeBtn">Cerrar</button>
          <button type="button" class="btn btn-primary" id="admin-download-transcript">
            <i class="fas fa-download me-1"></i><span data-key="downloadBtn">Descargar</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/build/highlight.min.js"></script>
  <script src="/scripts/dashboard/tickets.js"></script>
  <script src="/scripts/index.js"></script>
</body>

</html>