{"version":3,"file":"guildMemberAdd.js","sources":["src/interfaces/messaging/modules/discord/bot/events/client/guildMemberAdd.ts"],"sourceRoot":"/","sourcesContent":["import { CaptchaGenerator } from \"captcha-canvas\";\r\nimport { AttachmentBuilder, Message } from \"discord.js\";\r\n\r\nimport { Event } from \"@/interfaces/messaging/modules/discord/structure/utils/builders\";\r\nimport { client, main } from \"@/main\";\r\nimport { EmbedCorrect } from \"@/shared/adapters/extends/embeds.extend\";\r\n\r\nexport default new Event(\"guildMemberAdd\", async (member) => {\r\n  const { guild, id } = member;\r\n  if (!guild) return;\r\n\r\n  const messages = {\r\n    success: `${client.getEmoji(member.guild.id, \"correct\")} Thanks for joining **${guild.name}**! You have now gained access to the server.`,\r\n    failed: `${client.getEmoji(member.guild.id, \"error\")} Oh no! You failed the verification stage. Please try again.`,\r\n    timedout: `${client.getEmoji(member.guild.id, \"error\")}Oh no! You failed! Next time, be a little faster.`,\r\n    wrongCode: `${client.getEmoji(member.guild.id, \"error\")}Oh no! You sent me the wrong captcha. Please try again.`,\r\n    dmDisabled: `${client.getEmoji(member.guild.id, \"error\")}Oh no! Your DMs are disabled.`,\r\n    roleInvalid: `${client.getEmoji(member.guild.id, \"error\")} Oh no! I couldn't find the verification role. Please contact a staff member.`,\r\n    description: `Please type the captcha below to be able to access **${guild.name}**.`,\r\n    notes: [\r\n      `1. Type out the traced colored characters from left to right.`,\r\n      `2. Ignore the decoy characters spread-around.`,\r\n      `3. You don't have to respect characters cases (upper/lower case)!`,\r\n    ].join(\"\\n\"),\r\n  };\r\n\r\n  const settings = await main.prisma.myGuild.findFirst({\r\n    where: { guildId: guild.id },\r\n    select: { captcha: true },\r\n  });\r\n\r\n  if (!settings) return;\r\n  if (!settings.captcha) return;\r\n  if (!settings.captcha.isEnabled) return;\r\n  if (!member.kickable) return;\r\n  if (member.user.bot) return;\r\n\r\n  const captcha = new CaptchaGenerator()\r\n    .setDimension(150, 450)\r\n    .setCaptcha({\r\n      size: 60,\r\n      color: \"#5865f2\",\r\n    })\r\n    .setDecoy({ opacity: 0.5 })\r\n    .setTrace({ color: \"#5865f2\" });\r\n  const attachment = new AttachmentBuilder(captcha.generateSync(), {\r\n    name: \"captcha.png\",\r\n    description: \"Captcha verification image.\",\r\n  });\r\n\r\n  let attempts = 0;\r\n\r\n  await member\r\n    .send({\r\n      embeds: [\r\n        new EmbedCorrect()\r\n          .setTitle(\"Verification Instructions\")\r\n          .setDescription(\r\n            `Welcome to **${guild.name}**! To gain access to the server, you need to complete the captcha verification.\\n\\n` +\r\n              `**Instructions:**\\n` +\r\n              `1. Type the traced colored characters from left to right.\\n` +\r\n              `2. Ignore the decoy characters spread around.\\n` +\r\n              `3. You don't need to respect character cases (uppercase/lowercase).\\n\\n` +\r\n              `**Attempts:** You have a maximum of 3 attempts to complete the verification.\\n` +\r\n              `**Failed Attempts:** ${attempts}/3`,\r\n          ),\r\n      ],\r\n    })\r\n    .catch(() => {\r\n      member.kick(messages.dmDisabled);\r\n    });\r\n\r\n  await member\r\n    .send({\r\n      embeds: [\r\n        new EmbedCorrect()\r\n          .setTitle(\"Verification Captcha\")\r\n          .setDescription(messages.description)\r\n          .addFields({ name: `Additional Notes:`, value: messages.notes })\r\n          .setImage(`attachment://captcha.png`),\r\n      ],\r\n      files: [attachment],\r\n    })\r\n    .catch(() => {\r\n      member.kick(messages.dmDisabled);\r\n    });\r\n\r\n  const filter = (msg: Message) => msg.author.id === id;\r\n  const collector = member.dmChannel?.createMessageCollector({\r\n    filter,\r\n    time: 120000,\r\n    max: 3,\r\n  });\r\n\r\n  collector?.on(\"collect\", async (msg) => {\r\n    attempts++;\r\n    const memberInput = msg.content.toLowerCase();\r\n\r\n    if (memberInput === captcha.text?.toLowerCase()) {\r\n      const role = guild.roles.cache.find((r) => r.id === settings.captcha?.role);\r\n      if (role) {\r\n        member.roles.add(role);\r\n        member.send({\r\n          embeds: [new EmbedCorrect().setDescription(messages.success)],\r\n        });\r\n        if (attempts <= 2) {\r\n          collector.stop();\r\n        }\r\n      } else {\r\n        member.send({\r\n          embeds: [new EmbedCorrect().setDescription(messages.roleInvalid)],\r\n        });\r\n      }\r\n    } else {\r\n      if (attempts >= 3) {\r\n        member.send({\r\n          embeds: [\r\n            new EmbedCorrect().setDescription(\r\n              `${messages.failed} You will be kicked in 1 minute if you do not complete the verification.`,\r\n            ),\r\n          ],\r\n        });\r\n        setTimeout(() => {\r\n          member.kick(messages.failed);\r\n        }, 60000); // 1 minute\r\n      } else {\r\n        member.send({\r\n          embeds: [\r\n            new EmbedCorrect()\r\n              .setTitle(\"Verification Failed\")\r\n              .setDescription(\r\n                `You entered the wrong captcha. Please try again.\\n\\n` + `**Failed Attempts:** ${attempts}/3`,\r\n              ),\r\n          ],\r\n        });\r\n      }\r\n    }\r\n  });\r\n\r\n  collector?.on(\"end\", async (_collected, reason) => {\r\n    if (reason === \"time\") {\r\n      member.kick(messages.failed);\r\n      member.send({\r\n        embeds: [new EmbedCorrect().setDescription(messages.timedout)],\r\n      });\r\n    }\r\n  });\r\n});\r\n"],"names":[],"mappings":"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","debug_id":"d870488e-21ca-509e-b654-6eb14a66c844"}