<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%- title %></title>
  <meta name="description" content="Panel de administración de Nebura Works">
  <meta name="keywords" content="Nebura, Admin, Dashboard, Licencias, Usuarios, Logs">
  <meta name="author" content="Nebura">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="shortcut icon" href="/images/logo.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/administrator.css">
  <script>
    window.licenses = JSON.parse("<%- JSON.stringify(licenses).replace(/\\/g, '\\\\').replace(/\"/g, '\\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r') %>");
    window.logs = JSON.parse("<%- JSON.stringify(recentLogs).replace(/\\/g, '\\\\').replace(/\"/g, '\\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r') %>");
    window.users = JSON.parse("<%- JSON.stringify(users).replace(/\\/g, '\\\\').replace(/\"/g, '\\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r') %>");
    window.userIdFromUrl = JSON.parse('<%- JSON.stringify(userIdFromUrl) %>');
    window.usersMap = JSON.parse('<%- JSON.stringify(usersMap) %>');
    window.user = JSON.parse('<%- JSON.stringify(user) %>');
  </script>
</head>

<body style="background: var(--background-color-dark); color: var(--text-color-dark);">
  <div id="tsparticles"></div>
  <div id="app-container">
    <div class="d-flex" style="min-height: 100vh;">
      <!-- SIDEBAR -->
      <%- include('partials/sidebar', { user: user, panelPrincipalHtml: ` <li class="nav-item">
        <a class="nav-link" id="tickets-link" href="#">
          <i class="fas fa-ticket-alt"></i>
          <span>Tickets</span>
        </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/dashboard/support">
            <i class="fas fa-headset"></i>
            <span>Soporte</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://help.hiroshi-dev.me/">
            <i class="fas fa-book"></i>
            <span>Documentacion</span>
          </a>
        </li>
        ` }) %>
      <!-- CONTENIDO PRINCIPAL -->
      <main class="flex-grow-1 p-4" style="background: var(--background-color-dark); color: var(--text-color-dark);">
        <!-- HEADER DE ACCIONES (tema e idioma) -->
        <div class="d-flex justify-content-end align-items-center mb-3 gap-3">
          <!-- Buscador global -->
          <div class="search-group" id="global-search-group" style="width:320px;">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="global-search" class="form-control form-control-sm" autocomplete="off" data-i18n-placeholder="searchAll" placeholder="Buscar en todo el panel..." style="background: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);" />
            <button type="button" class="clear-btn" id="clear-global-search" tabindex="-1" aria-label="Limpiar búsqueda">
              <i class="fas fa-times-circle"></i>
            </button>
          </div>
          <!-- Cambiar idioma -->
          <div class="language-switcher">
            <a href="#" class="lang-link active" data-lang="es">ES</a> |
            <a href="#" class="lang-link" data-lang="en">EN</a>
          </div>
          <!-- Cambiar tema -->
          <div class="form-check form-switch ms-3">
            <input class="form-check-input" type="checkbox" id="themeSwitch" checked>
            <label class="form-check-label" for="themeSwitch">
              <i class="fas fa-sun"></i>
            </label>
          </div>
        </div>

        <!-- SECCIÓN DE BIENVENIDA -->
        <div class="admin-header d-flex align-items-center fade-in" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: var(--border-radius); color: #fff; box-shadow: var(--box-shadow);">
          <img src="<%= user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=256` : '/images/logo.png' %>" alt="Admin Avatar" class="admin-avatar">
          <div>
            <div class="welcome-title" data-i18n="welcomeTitle">Bienvenido, <%= user.name || user.global_name || user.username %>
            </div>
            <div class="welcome-desc" data-i18n="welcomeDesc">Panel de administración de Nebura. Gestiona usuarios, licencias, métricas, clientes y logs desde un solo lugar.</div>
            <div class="admin-badges mt-2">
              <span class="badge badge-role <%= user.role %> text-uppercase"><i class="fas fa-user-shield me-1"></i>
                <%= user.role %>
              </span>
              <span class="badge bg-secondary"><i class="fas fa-envelope me-1"></i>
                <%= user.email %>
              </span>
              <span class="badge bg-dark"><i class="fas fa-calendar-alt me-1"></i> Registrado: <%= user.createdAt ?
                    user.createdAt.toLocaleDateString() : '-' %></span>
            </div>
          </div>
        </div>

        <!-- NAV TABS -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist" style="border-bottom: 1px solid var(--border-color-dark);">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-tab-pane" type="button" role="tab" aria-controls="info-tab-pane" aria-selected="true" data-i18n="infoTab">
              <i class="fas fa-info-circle"></i> Información
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-tab-pane" type="button" role="tab" aria-controls="config-tab-pane" aria-selected="false" data-i18n="configTab">
              <i class="fas fa-cogs"></i> Configuración
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-tab-pane" type="button" role="tab" aria-controls="tasks-tab-pane" aria-selected="false" data-i18n="tasksTab">
              <i class="fa-solid fa-list-check"></i> Tareas
            </button>
          </li>
          <!-- NUEVA PESTAÑA PARA LICENCIAS -->
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="licensesui-tab" data-bs-toggle="tab" data-bs-target="#licensesui-tab-pane" type="button" role="tab" aria-controls="licensesui-tab-pane" aria-selected="false" data-i18n="licensesUITab">
              <i class="fa-solid fa-key"></i> Licencias
            </button>
          </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
          <!-- TAB INFORMACIÓN -->
          <div class="tab-pane fade show active" id="info-tab-pane" role="tabpanel" aria-labelledby="info-tab" tabindex="0">
            <!-- SUBTABS DE INFORMACIÓN -->
            <ul class="nav nav-pills mb-4" id="infoSubTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="datos-info-tab" data-bs-toggle="pill" data-bs-target="#datos-info-pane" type="button" role="tab" aria-controls="datos-info-pane" aria-selected="true" data-i18n="datosTab">
                  <i class="fas fa-table"></i> Datos
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="estadisticas-info-tab" data-bs-toggle="pill" data-bs-target="#estadisticas-info-pane" type="button" role="tab" aria-controls="estadisticas-info-pane" aria-selected="false" data-i18n="estadisticasTab">
                  <i class="fas fa-chart-bar"></i> Estadísticas
                </button>
              </li>
            </ul>
            <div class="tab-content" id="infoSubTabsContent">
              <!-- DATOS -->
              <div class="tab-pane fade show active" id="datos-info-pane" role="tabpanel" aria-labelledby="datos-info-tab" tabindex="0">
                <!-- MÉTRICAS DEL SISTEMA (puedes dejar aquí los contadores generales) -->
                <div class="row fade-in">
                  <div class="col-md-3">
                    <div class="count-box">
                      <div class="section-title mb-2"><i class="fas fa-users"></i> Usuarios</div>
                      <h2>
                        <%= users.length %>
                      </h2>
                      <div class="text-muted">Total registrados</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="count-box">
                      <div class="section-title mb-2"><i class="fas fa-key"></i> Licencias</div>
                      <h2>
                        <%= licenses.length %>
                      </h2>
                      <div class="text-muted">Total emitidas</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="count-box">
                      <div class="section-title mb-2"><i class="fas fa-server"></i> Clientes Discord</div>
                      <h2>
                        <%= myclientDiscord.length %>
                      </h2>
                      <div class="text-muted">Integraciones</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="count-box">
                      <div class="section-title mb-2"><i class="fas fa-chart-line"></i> Métricas</div>
                      <h2>
                        <%= metrics.length %>
                      </h2>
                      <div class="text-muted">Endpoints monitorizados</div>
                    </div>
                  </div>
                </div>

                <!-- USUARIOS -->
                <div class="card fade-in" style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
                  <div class="card-header d-flex justify-content-between align-items-center" style="background: rgba(30, 30, 30, 0.7); border-bottom: 1px solid var(--border-color-dark); color: var(--text-color-dark);">
                    <span class="section-title mb-0" data-i18n="users"><i class="fas fa-users"></i> Usuarios</span>
                    <div class="d-flex align-items-center gap-2">
                      <!-- Botón modo compacto/expandido -->
                      <button class="btn btn-outline-secondary btn-sm" id="users-compact-toggle" title="Modo compacto/expandido" data-i18n-title="compactToggle">
                        <i class="fas fa-compress-arrows-alt"></i>
                      </button>
                      <!-- Botón columnas configurables -->
                      <button class="btn btn-outline-secondary btn-sm" id="users-columns-toggle" title="Columnas" data-i18n-title="columnsToggle">
                        <i class="fas fa-table-columns"></i>
                      </button>
                      <!-- Botón exportar -->
                      <div class="dropdown">
                        <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-i18n="export">
                          <i class="fas fa-file-export"></i> Exportar
                        </button>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#" id="export-users-csv" data-i18n="exportCSV">CSV</a></li>
                          <li><a class="dropdown-item" href="#" id="export-users-xlsx" data-i18n="exportExcel">Excel</a></li>
                        </ul>
                      </div>
                      <div class="search-group search-group-animate-in" id="users-search-group">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-users" class="form-control form-control-sm" autocomplete="off" data-i18n-placeholder="searchUsers" placeholder="Buscar por nombre, email o rol" />
                        <button type="button" class="clear-btn" id="clear-search-users" tabindex="-1" aria-label="Limpiar búsqueda">
                          <i class="fas fa-times-circle"></i>
                        </button>
                        <span class="search-spinner" id="spinner-search-users"></span>
                      </div>
                      <select class="advanced-filter" id="users-advanced-filter">
                        <option value="" data-i18n="all">Todos</option>
                        <option value="name" data-i18n="name">Nombre</option>
                        <option value="email" data-i18n="email">Email</option>
                        <option value="role" data-i18n="role">Rol</option>
                      </select>
                      <!-- <span class="text-muted">Total: <%= users.length %></span> -->
                    </div>
                  </div>
                  <div class="card-body table-responsive">
                    <!-- Filtros avanzados -->
                    <div class="row mb-2">
                      <div class="col-md-4">
                        <input type="date" class="form-control form-control-sm" id="users-filter-date-from" placeholder="Desde">
                      </div>
                      <div class="col-md-4">
                        <input type="date" class="form-control form-control-sm" id="users-filter-date-to" placeholder="Hasta">
                      </div>
                      <div class="col-md-4">
                        <select class="form-select form-select-sm" id="users-filter-status">
                          <option value="" data-i18n="allStates">Todos los estados</option>
                          <option value="inactive" data-i18n="inactive">Inactivo</option>
                          <option value="active" data-i18n="active">Activo</option>
                        </select>
                      </div>
                    </div>
                    <table class="table table-hover align-middle mb-0" id="users-table" style="background: var(--card-bg-dark); color: var(--text-color-dark);">
                      <thead>
                        <tr>
                          <th style="cursor:pointer" data-sort="name" class="sortable">Nombre <i class="fa fa-sort"></i>
                          </th>
                          <th style="cursor:pointer" data-sort="email" class="sortable">Email <i class="fa fa-sort"></i>
                          </th>
                          <th style="cursor:pointer" data-sort="role" class="sortable">Rol <i class="fa fa-sort"></i></th>
                          <th style="cursor:pointer" data-sort="createdAt" class="sortable">Registrado <i class="fa fa-sort"></i></th>
                          <th style="cursor:pointer" data-sort="licenses" class="sortable">Licencias <i class="fa fa-sort"></i></th>
                          <th style="cursor:pointer" data-sort="updatedAt" class="sortable">Última actualización <i class="fa fa-sort"></i></th>
                        </tr>
                      </thead>
                      <tbody id="users-table-body">
                        <% users.forEach(u=> { %>
                        <tr>
                          <td>
                            <span class="badge bg-primary" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Nombre de usuario">
                              <%= u.name %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-secondary" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Email">
                              <%= u.email %>
                            </span>
                          </td>
                          <td>
                            <span class="badge badge-role <%= u.role %> text-uppercase" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Rol">
                              <%= u.role %>
                            </span>
                          </td>
                          <td>
                            <span data-bs-toggle="tooltip" title="Fecha de registro">
                              <%= u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '-' %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-info" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Cantidad de licencias">
                              <%= licenses.filter(l=> l.userId === u.id).length %>
                            </span>
                          </td>
                          <td>
                            <span data-bs-toggle="tooltip" title="Última actualización">
                              <%= u.updatedAt ? new Date(u.updatedAt).toLocaleDateString() : '-' %>
                            </span>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>
                    <nav>
                      <ul class="pagination pagination-sm justify-content-end" id="users-pagination"></ul>
                    </nav>
                  </div>
                </div>

                <!-- LICENCIAS -->
                <div class="card fade-in" style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
                  <div class="card-header d-flex justify-content-between align-items-center" style="background: rgba(30, 30, 30, 0.7); border-bottom: 1px solid var(--border-color-dark); color: var(--text-color-dark);">
                    <span class="section-title mb-0" data-i18n="licenses"><i class="fas fa-key"></i> Licencias</span>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-outline-secondary btn-sm" id="licenses-compact-toggle" title="Modo compacto/expandido">
                        <i class="fas fa-compress-arrows-alt"></i>
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" id="licenses-columns-toggle" title="Columnas">
                        <i class="fas fa-table-columns"></i>
                      </button>
                      <div class="dropdown">
                        <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="fas fa-file-export"></i> Exportar
                        </button>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#" id="export-licenses-csv">CSV</a></li>
                          <li><a class="dropdown-item" href="#" id="export-licenses-xlsx">Excel</a></li>
                        </ul>
                      </div>
                      <div class="search-group search-group-animate-in" id="licenses-search-group">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-licenses" class="form-control form-control-sm" autocomplete="off" data-i18n-placeholder="searchLicenses" placeholder="Buscar por ID, tipo, usuario, admin o estado" />
                        <button type="button" class="clear-btn" id="clear-search-licenses" tabindex="-1" aria-label="Limpiar búsqueda">
                          <i class="fas fa-times-circle"></i>
                        </button>
                        <span class="search-spinner" id="spinner-search-licenses"></span>
                      </div>
                      <select class="advanced-filter" id="licenses-advanced-filter">
                        <option value="" data-i18n="all">Todos</option>
                        <option value="id" data-i18n="id">ID</option>
                        <option value="type" data-i18n="type">Tipo</option>
                        <option value="user" data-i18n="user">Usuario</option>
                        <option value="admin" data-i18n="admin">Admin</option>
                        <option value="status" data-i18n="status">Estado</option>
                      </select>
                      <!-- <span class="text-muted">Total: <%= licenses.length %></span> -->
                    </div>
                  </div>
                  <div class="card-body table-responsive">
                    <div class="row mb-2">
                      <div class="col-md-4">
                        <input type="date" class="form-control form-control-sm" id="licenses-filter-date-from" placeholder="Desde">
                      </div>
                      <div class="col-md-4">
                        <input type="date" class="form-control form-control-sm" id="licenses-filter-date-to" placeholder="Hasta">
                      </div>
                      <div class="col-md-4">
                        <select class="form-select form-select-sm" id="licenses-filter-status">
                          <option value="" data-i18n="allStates">Todos los estados</option>
                          <option value="ACTIVE" data-i18n="active">Activa</option>
                          <option value="EXPIRED" data-i18n="expired">Expirada</option>
                          <option value="BANNED" data-i18n="banned">Baneada</option>
                          <option value="REVOKED" data-i18n="revoked">Revocada</option>
                        </select>
                      </div>
                    </div>
                    <table class="table table-hover align-middle mb-0" id="licenses-table" style="background: var(--card-bg-dark); color: var(--text-color-dark);">
                      <thead>
                        <tr>
                          <th style="cursor:pointer" data-sort="id" class="sortable">ID <i class="fa fa-sort"></i></th>
                          <th style="cursor:pointer" data-sort="type" class="sortable">Tipo <i class="fa fa-sort"></i>
                          </th>
                          <th style="cursor:pointer" data-sort="user" class="sortable">Usuario <i class="fa fa-sort"></i>
                          </th>
                          <th style="cursor:pointer" data-sort="admin" class="sortable">Admin <i class="fa fa-sort"></i>
                          </th>
                          <th>HWID</th>
                          <th style="cursor:pointer" data-sort="status" class="sortable">Estado <i class="fa fa-sort"></i>
                          </th>
                          <th style="cursor:pointer" data-sort="validUntil" class="sortable">Válida hasta <i class="fa fa-sort"></i></th>
                          <th style="cursor:pointer" data-sort="requests" class="sortable">Solicitudes <i class="fa fa-sort"></i></th>
                          <th>Última IP</th>
                        </tr>
                      </thead>
                      <tbody id="licenses-table-body">
                        <% licenses.forEach(l=> {
                            let userLic=users.find(u=> u.id === l.userId);
                            let adminLic=users.find(u=> u.id === l.adminId);
                            let status = 'ACTIVE';
                            if (l.validUntil && new Date(l.validUntil) < new Date()) status='EXPIRED' ; if
                              (l.status==='BANNED' ) status='BANNED' ; if (l.status==='REVOKED' ) status='REVOKED' ; let
                              estadoIcon=status==='ACTIVE'
                              ? '<i class="fa fa-check-circle text-success" title="Activa"></i>' : status==='EXPIRED'
                              ? '<i class="fa fa-clock text-warning" title="Expirada"></i>'
                              : '<i class="fa fa-ban text-danger" title="Revocada/Baneada"></i>' ; %>
                        <tr>
                          <td>
                            <span class="badge bg-primary" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="ID de licencia">
                              <%= l.id %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-info" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Tipo de licencia">
                              <%= l.type %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-secondary" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Usuario">
                              <%= userLic ? userLic.name : l.userId %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-secondary" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Admin">
                              <%= adminLic ? adminLic.name : l.adminId %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-dark" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="HWID">
                              <%= Array.isArray(l.hwid) ? l.hwid.join(', ') : '' %>
                            </span>
                          </td>
                          <td>
                            <span class="badge badge-status <%= status %> <%= status === ' ACTIVE' ? 'bg-success' :
                                      status==='EXPIRED' ? 'bg-warning text-dark' : 'bg-danger' %>" style="cursor:pointer;" data-bs-toggle="tooltip" title="<%= status==='ACTIVE' ? 'Licencia activa y válida' :
                                        status==='EXPIRED' ? 'Licencia expirada' : 'Licencia revocada/baneada' %>">
                              <%- estadoIcon %>
                              <%= status %>
                            </span>
                          </td>
                          <td>
                            <span data-bs-toggle="tooltip" title="<%= l.validUntil ? new Date(l.validUntil).toLocaleString() : '-' %>">
                              <%= l.validUntil ? new Date(l.validUntil).toLocaleDateString() : '-' %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-info" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Solicitudes">
                              <%= l.requestCount %> / <%= l.requestLimit %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-secondary" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Última IP">
                              <%= l.lastUsedIp || '-' %>
                            </span>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>
                    <nav>
                      <ul class="pagination pagination-sm justify-content-end" id="licenses-pagination"></ul>
                    </nav>
                  </div>
                </div>

                <!-- CLIENTES DISCORD -->
                <div class="card fade-in" style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
                  <div class="card-header d-flex justify-content-between align-items-center" style="background: rgba(30, 30, 30, 0.7); border-bottom: 1px solid var(--border-color-dark); color: var(--text-color-dark);">
                    <span class="section-title mb-0" data-i18n="discordClients"><i class="fab fa-discord"></i> Clientes Discord</span>
                    <!-- <span class="text-muted">Total: <%= myclientDiscord.length %></span> -->
                  </div>
                  <div class="card-body table-responsive">
                    <table class="table table-hover align-middle">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Token</th>
                          <th>Version</th>
                          <th>Webhook</th>
                          <th>Mantenimiento</th>
                          <th>Creado</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% myclientDiscord.forEach(c=> { %>
                        <tr>
                          <td>
                            <%= c.name %>
                          </td>
                          <td><code><%= c.clientId.slice(0, 8) %>...<%= c.clientId.slice(-4) %></code></td>
                          <td>
                            <%= c.version %>
                          </td>
                          <td><span class="badge <%= c.webhookUrl ? 'bg-danger' : 'bg-secondary' %>">
                              <%= c.webhookUrl ? 'Sí' : 'No' %>
                            </span></td>
                          </td>
                          <td>
                            <span class="badge <%= c.maintenance ? 'bg-danger' : 'bg-secondary' %>">
                              <%= c.maintenance ? 'Sí' : 'No' %>
                            </span>
                          </td>
                          <td>
                            <%= c.createdAt ? new Date(c.createdAt).toLocaleDateString() : ' -' %>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <!-- ESTADÍSTICAS -->
              <div class="tab-pane fade" id="estadisticas-info-pane" role="tabpanel" aria-labelledby="estadisticas-info-tab" tabindex="0">
                <!-- MÉTRICAS -->
                <div class="card fade-in" style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
                  <div class="card-header d-flex justify-content-between align-items-center" style="background: rgba(30, 30, 30, 0.7); border-bottom: 1px solid var(--border-color-dark); color: var(--text-color-dark);">
                    <span class="section-title mb-0" data-i18n="metrics"><i class="fas fa-chart-line"></i> Métricas de Endpoints</span>
                    <!-- <span class="text-muted">Total: <%= metrics.length %></span> -->
                  </div>
                  <div class="card-body table-responsive">
                    <table class="table table-hover align-middle">
                      <thead>
                        <tr>
                          <th>Endpoint</th>
                          <th>Cliente</th>
                          <th>Sistema</th>
                          <th>Solicitudes</th>
                          <th>Errores</th>
                          <th>Latencia Promedio</th>
                          <th>Última actualización</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% metrics.forEach(m=> { %>
                        <tr>
                          <td>
                            <%= m.endpoint %>
                          </td>
                          <td>
                            <%= m.clientId || '-' %>
                          </td>
                          <td>
                            <%= m.system %>
                          </td>
                          <td>
                            <%= m.requests %>
                          </td>
                          <td><span class="badge <%= m.errors > 0 ? 'bg-danger' : 'bg-success' %>">
                              <%= m.errors %>
                            </span></td>
                          </td>
                          <td>
                            <%= m.latency ? m.latency.toFixed(2) : '-' %> ms
                          </td>
                          <td>
                            <%= m.updatedAt ? new Date(m.updatedAt).toLocaleDateString() : '-' %>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- LOGS RECIENTES -->
                <div class="card fade-in" style="background: var(--card-bg-dark); border: 1px solid var(--input-border-dark);">
                  <div class="card-header d-flex justify-content-between align-items-center" style="background: rgba(30, 30, 30, 0.7); border-bottom: 1px solid var(--border-color-dark); color: var(--text-color-dark);">
                    <span class="section-title mb-0" data-i18n="logs"><i class="fas fa-file-alt"></i> Logs recientes</span>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-outline-secondary btn-sm" id="logs-compact-toggle" title="Modo compacto/expandido">
                        <i class="fas fa-compress-arrows-alt"></i>
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" id="logs-columns-toggle" title="Columnas">
                        <i class="fas fa-table-columns"></i>
                      </button>
                      <div class="dropdown">
                        <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="fas fa-file-export"></i> Exportar
                        </button>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#" id="export-logs-csv">CSV</a></li>
                          <li><a class="dropdown-item" href="#" id="export-logs-xlsx">Excel</a></li>
                        </ul>
                      </div>
                      <div class="search-group search-group-animate-in" id="logs-search-group">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-logs" class="form-control form-control-sm" autocomplete="off" data-i18n-placeholder="searchLogs" placeholder="Buscar por archivo" />
                        <button type="button" class="clear-btn" id="clear-search-logs" tabindex="-1" aria-label="Limpiar búsqueda">
                          <i class="fas fa-times-circle"></i>
                        </button>
                        <span class="search-spinner" id="spinner-search-logs"></span>
                      </div>
                      <select class="advanced-filter" id="logs-advanced-filter">
                        <option value="" data-i18n="all">Todos</option>
                        <option value="filename" data-i18n="file">Archivo</option>
                        <option value="isCompressed" data-i18n="compressed">Comprimido</option>
                      </select>
                      <!-- <span class="text-muted">Últimos <%= recentLogs.length %> archivos</span> -->
                    </div>
                  </div>
                  <div class="card-body table-responsive">
                    <div class="row mb-2">
                      <div class="col-md-6">
                        <input type="date" class="form-control form-control-sm" id="logs-filter-date-from" placeholder="Desde">
                      </div>
                      <div class="col-md-6">
                        <input type="date" class="form-control form-control-sm" id="logs-filter-date-to" placeholder="Hasta">
                      </div>
                    </div>
                    <table class="table table-hover align-middle mb-0" id="logs-table" style="background: var(--card-bg-dark); color: var(--text-color-dark);">
                      <thead>
                        <tr>
                          <th style="cursor:pointer" data-sort="filename" class="sortable">Archivo <i class="fa fa-sort"></i>
                          </th>
                          <th style="cursor:pointer" data-sort="lastModified" class="sortable">Última modificación <i class="fa fa-sort"></i></th>
                          <th style="cursor:pointer" data-sort="size" class="sortable">Tamaño <i class="fa fa-sort"></i>
                          </th>
                          <th style="cursor:pointer" data-sort="isCompressed" class="sortable">Comprimido <i class="fa fa-sort"></i></th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody id="logs-table-body">
                        <% recentLogs.forEach(log=> { %>
                        <tr>
                          <td>
                            <span class="badge bg-primary" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Nombre de archivo">
                              <%= log.filename %>
                            </span>
                          </td>
                          <td>
                            <span data-bs-toggle="tooltip" title="Última modificación">
                              <%= log.lastModified ? new Date(log.lastModified).toLocaleString() : '-' %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-info" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="Tamaño">
                              <%= log.size %>
                            </span>
                          </td>
                          <td>
                            <span class="badge <%= log.isCompressed ? 'bg-success' : 'bg-secondary' %>" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="¿Comprimido?">
                              <%= log.isCompressed ? 'Sí' : 'No' %>
                            </span>
                          </td>
                          <td>
                            <a href="/dashboard/utils/logs/<%= log.filename %>" class="btn btn-sm btn-outline-primary" target="_blank" data-bs-toggle="tooltip" title="Ver">
                              <i class="fas fa-eye"></i>
                            </a>
                            <a href="/dashboard/utils/logs/<%= log.filename %>?download=1" class="btn btn-sm btn-outline-success" target="_blank" data-bs-toggle="tooltip" title="Descargar">
                              <i class="fas fa-download"></i>
                            </a>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>
                    <nav>
                      <ul class="pagination pagination-sm justify-content-end" id="logs-pagination"></ul>
                    </nav>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- TAB CONFIGURACIÓN -->
          <div class="tab-pane fade" id="config-tab-pane" role="tabpanel" aria-labelledby="config-tab" tabindex="0">
            <!-- SUBTABS DE CONFIGURACIÓN -->
            <ul class="nav nav-pills mb-4" id="configSubTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="api-config-tab" data-bs-toggle="pill" data-bs-target="#api-config-pane" type="button" role="tab" aria-controls="api-config-pane" aria-selected="true">
                  <i class="fas fa-server"></i> API
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="general-config-tab" data-bs-toggle="pill" data-bs-target="#general-config-pane" type="button" role="tab" aria-controls="general-config-pane" aria-selected="false">
                  <i class="fas fa-cogs"></i> General
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="discord-config-tab" data-bs-toggle="pill" data-bs-target="#discord-config-pane" type="button" role="tab" aria-controls="discord-config-pane" aria-selected="false">
                  <i class="fab fa-discord"></i> Discord
                </button>
              </li>
            </ul>
            <div class="tab-content" id="configSubTabsContent">
              <!-- API CONFIG -->
              <div class="tab-pane fade show active" id="api-config-pane" role="tabpanel" aria-labelledby="api-config-tab" tabindex="0">
                <!-- SECCIÓN DE ACTUALIZACIÓN DE ROLES DE USUARIO -->
                <div class="card fade-in mb-4">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="section-title mb-0"><i class="fas fa-user-cog"></i> Gestión de Roles de Usuario</span>
                  </div>
                  <div class="card-body">
                    <% if (user.role !=="owner" ) { %>
                    <div class="alert alert-danger mb-3" data-i18n="onlyOwner">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      Solo los usuarios con rango <strong>owner</strong> pueden actualizar roles.
                    </div>
                    <% } %>
                    <form id="role-update-form" class="row g-3 align-items-end" <%=(user.role &&
                            user.role.trim().toLowerCase() !=="owner" ) ? 'style="pointer-events:none;opacity:0.7;"' : '' %>>
                      <div class="col-md-5">
                        <label for="select-user" class="form-label" data-i18n="selectUser">Seleccionar usuario</label>
                        <select class="form-select" id="select-user" required>
                          <option value="" disabled selected>Elige un usuario...</option>
                          <% users.forEach(u=> { %>
                          <option value="<%= u.id %>">
                            <%= u.name %> (<%= u.email %>) - <%= u.role %>
                          </option>
                          <% }) %>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label for="select-role" class="form-label" data-i18n="selectRole">Nuevo rol</label>
                        <select class="form-select" id="select-role" required>
                          <option value="" disabled selected>Selecciona un rol...</option>
                          <option value="admin">admin</option>
                          <option value="user">user</option>
                          <option value="guest">guest</option>
                          <option value="developer">developer</option>
                          <option value="owner">owner</option>
                        </select>
                      </div>
                      <div class="col-md-3 d-grid">
                        <button type="submit" class="btn btn-primary" data-i18n="updateRole">
                          <i class="fas fa-save me-1"></i> Actualizar Rol
                        </button>
                      </div>
                    </form>
                    <div id="role-update-result" class="mt-3"></div>
                  </div>
                </div>
              </div>
              <!-- GENERAL CONFIG -->
              <div class="tab-pane fade" id="general-config-pane" role="tabpanel" aria-labelledby="general-config-tab" tabindex="0">
                <!-- SECCION DE ACTUALIZACIÓN DEL CLIENTE -->
                <div class="card fade-in mb-4">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="section-title mb-0"><i class="fas fa-user-cog"></i> Configuración del Cliente</span>
                  </div>
                  <div class="card-body">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs mb-4" id="clientConfigTabs" role="tablist">
                      <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="client-tab" data-bs-toggle="tab" data-bs-target="#client-tab-pane" type="button" role="tab" aria-controls="client-tab-pane" aria-selected="true">
                          <i class="fas fa-users"></i> Clientes
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="discord-tab" data-bs-toggle="tab" data-bs-target="#discord-tab-pane" type="button" role="tab" aria-controls="discord-tab-pane" aria-selected="false">
                          <i class="fab fa-discord"></i> Discord
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="whatsapp-tab" data-bs-toggle="tab" data-bs-target="#whatsapp-tab-pane" type="button" role="tab" aria-controls="whatsapp-tab-pane" aria-selected="false">
                          <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                      </li>
                    </ul>

                    <!-- Tab panes -->
                    <div class="tab-content" id="clientConfigTabsContent">
                      <!-- Client Tab -->
                      <div class="tab-pane fade show active" id="client-tab-pane" role="tabpanel" aria-labelledby="client-tab" tabindex="0">
                        <div class="d-flex justify-content-between mb-3">
                          <h5 class="mb-0" data-i18n="clientManagementTitle">Gestión de Clientes</h5>
                          <button class="btn btn-primary btn-sm" id="add-client-btn" data-i18n="newClient">
                            <i class="fas fa-plus me-1"></i> Nuevo Cliente
                          </button>
                        </div>

                        <div class="table-responsive">
                          <table class="table table-hover align-middle" id="clients-table">
                            <thead>
                              <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Version</th>
                                <th>Mantenimiento</th>
                                <th>Estado</th>
                                <th>Creado</th>
                                <th>Acciones</th>
                              </tr>
                            </thead>
                            <tbody id="clients-table-body">
                              <!-- Se llenará dinámicamente -->
                            </tbody>
                          </table>
                          <div class="d-flex justify-content-center">
                            <nav>
                              <ul class="pagination pagination-sm" id="clients-pagination"></ul>
                            </nav>
                          </div>
                        </div>
                      </div>

                      <!-- Discord Tab -->
                      <div class="tab-pane fade" id="discord-tab-pane" role="tabpanel" aria-labelledby="discord-tab" tabindex="0">
                        <div class="d-flex justify-content-between mb-3">
                          <h5 class="mb-0" data-i18n="discordSettingsTitle">Configuraciones de Discord</h5>
                          <button class="btn btn-primary btn-sm" id="add-discord-btn" data-i18n="newDiscordConfig">
                            <i class="fas fa-plus me-1"></i> Nueva Configuración
                          </button>
                        </div>

                        <div class="table-responsive">
                          <table class="table table-hover align-middle" id="discord-table">
                            <thead>
                              <tr>
                                <th>ID</th>
                                <th>Token</th>
                                <th>Client ID</th>
                                <th>Estado</th>
                                <th>Webhook</th>
                                <th>Acciones</th>
                              </tr>
                            </thead>
                            <tbody id="discord-table-body">
                              <!-- Se llenará dinámicamente -->
                            </tbody>
                          </table>
                          <div class="d-flex justify-content-center">
                            <nav>
                              <ul class="pagination pagination-sm" id="discord-pagination"></ul>
                            </nav>
                          </div>
                        </div>
                      </div>

                      <!-- WhatsApp Tab -->
                      <div class="tab-pane fade" id="whatsapp-tab-pane" role="tabpanel" aria-labelledby="whatsapp-tab" tabindex="0">
                        <div class="d-flex justify-content-between mb-3">
                          <h5 class="mb-0" data-i18n="whatsappSettingsTitle">Configuraciones de WhatsApp</h5>
                          <button class="btn btn-primary btn-sm" id="add-whatsapp-btn" data-i18n="newWhatsappConfig">
                            <i class="fas fa-plus me-1"></i> Nueva Configuración
                          </button>
                        </div>

                        <div class="table-responsive">
                          <table class="table table-hover align-middle" id="whatsapp-table">
                            <thead>
                              <tr>
                                <th>ID</th>
                                <th>Número</th>
                                <th>API Key</th>
                                <th>Estado</th>
                                <th>Webhook</th>
                                <th>Acciones</th>
                              </tr>
                            </thead>
                            <tbody id="whatsapp-table-body">
                              <!-- Se llenará dinámicamente -->
                            </tbody>
                          </table>
                          <div class="d-flex justify-content-center">
                            <nav>
                              <ul class="pagination pagination-sm" id="whatsapp-pagination"></ul>
                            </nav>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Backup Viewer Section -->
                <div class="card fade-in mb-4">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="section-title mb-0"><i class="fas fa-database"></i> Gestión de Backups</span>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-outline-secondary btn-sm" id="refresh-backups-btn" title="Refrescar lista">
                        <i class="fas fa-sync-alt"></i>
                      </button>
                      <button class="btn btn-outline-primary btn-sm" id="create-backup-btn" title="Crear nuevo backup">
                        <i class="fas fa-plus"></i> Nuevo Backup
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Backup List -->
                    <div class="table-responsive mb-4">
                      <table class="table table-hover align-middle mb-0" id="backups-table">
                        <thead>
                          <tr>
                            <th style="cursor:pointer" data-sort="name" class="sortable">Nombre <i class="fa fa-sort"></i></th>
                            <th style="cursor:pointer" data-sort="date" class="sortable">Fecha <i class="fa fa-sort"></i></th>
                            <th style="cursor:pointer" data-sort="size" class="sortable">Tamaño <i class="fa fa-sort"></i></th>
                            <th>Contenido</th>
                            <th>Acciones</th>
                          </tr>
                        </thead>
                        <tbody id="backups-table-body">
                          <% if (backups && backups.length > 0) { %>
                          <% backups.forEach(backup => { 
              const fileName = backup.name;
              const dateStr = fileName.match(/backup-(\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}-\d{3}Z)/);
              const date = dateStr ? new Date(dateStr[1].replace(/-/g, ':')) : new Date();
            %>
                          <tr data-backup-file="<%= backup.name %>">
                            <td>
                              <span class="badge bg-primary" style="font-size:0.95em;cursor:pointer;" data-bs-toggle="tooltip" title="<%= backup.name %>">
                                <%= backup.name %>
                              </span>
                            </td>
                            <td>
                              <span data-bs-toggle="tooltip" title="<%= date.toLocaleString() %>">
                                <%= date.toLocaleDateString() %>
                              </span>
                            </td>
                            <td>
                              <span class="badge bg-info">
                                <% 
                    // Simular tamaño ya que no lo tenemos en los datos
                    const size = Math.floor(Math.random() * 500) + 100;
                  %>
                                <%= size %> KB
                              </span>
                            </td>
                            <td>
                              <button class="btn btn-sm btn-outline-info view-backup-btn" data-backup-file="<%= backup.name %>">
                                <i class="fas fa-eye"></i> Ver contenido
                              </button>
                            </td>
                            <td>
                              <div class="btn-group btn-group-sm" role="group">
                                <a href="<%= backup.path %>" class="btn btn-outline-success" download>
                                  <i class="fas fa-download"></i>
                                </a>
                                <button class="btn btn-outline-danger delete-backup-btn" data-backup-file="<%= backup.name %>">
                                  <i class="fas fa-trash"></i>
                                </button>
                              </div>
                            </td>
                          </tr>
                          <% }) %>
                          <% } else { %>
                          <tr>
                            <td colspan="5" class="text-center text-muted py-4">No hay backups disponibles</td>
                          </tr>
                          <% } %>
                        </tbody>
                      </table>
                    </div>

                    <!-- Backup Details Viewer -->
                    <div class="card" id="backup-details-card" style="display: none;">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Detalles del Backup: <span id="backup-details-title"></span></h5>
                        <button class="btn btn-sm btn-outline-secondary" id="close-backup-details">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                      <div class="card-body">
                        <div class="row mb-3">
                          <div class="col-md-4">
                            <div class="card bg-dark">
                              <div class="card-header">Resumen</div>
                              <div class="card-body">
                                <ul class="list-group list-group-flush" id="backup-summary">
                                  <li class="list-group-item bg-dark">Cargando...</li>
                                </ul>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-8">
                            <div class="card bg-dark">
                              <div class="card-header">Explorador de Datos</div>
                              <div class="card-body">
                                <div class="mb-3">
                                  <select class="form-select" id="backup-data-select">
                                    <option value="">Selecciona una categoría...</option>
                                    <option value="userAPI">Usuarios API</option>
                                    <option value="license">Licencias</option>
                                    <option value="myDiscord">Clientes Discord</option>
                                    <option value="myGuild">Servidores</option>
                                    <option value="userEconomy">Economía</option>
                                    <option value="userLevel">Niveles</option>
                                    <option value="metrics">Métricas</option>
                                  </select>
                                </div>
                                <div class="table-responsive">
                                  <table class="table table-sm table-hover" id="backup-data-table">
                                    <thead>
                                      <tr>
                                        <th>ID</th>
                                        <th>Detalles</th>
                                      </tr>
                                    </thead>
                                    <tbody id="backup-data-body">
                                      <tr>
                                        <td colspan="2" class="text-center text-muted py-3">Selecciona una categoría para ver los datos</td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="card bg-dark">
                          <div class="card-header">JSON Completo</div>
                          <div class="card-body">
                            <pre id="backup-json-viewer" style="height: 300px; overflow: auto; background: #1a1a1a; padding: 10px; border-radius: 5px;">Selecciona un backup para ver el contenido completo</pre>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Backup Modal -->
                <div class="modal fade" id="backupModal" tabindex="-1" aria-labelledby="backupModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="backupModalLabel">Crear Nuevo Backup</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <form id="backupForm">
                          <div class="mb-3">
                            <label for="backupName" class="form-label">Nombre del Backup</label>
                            <input type="text" class="form-control" id="backupName" value="backup-<%= new Date().toISOString().replace(/[:.]/g, '-') %>" readonly>
                          </div>
                          <div class="mb-3">
                            <label for="backupDescription" class="form-label">Descripción (opcional)</label>
                            <textarea class="form-control" id="backupDescription" rows="2"></textarea>
                          </div>
                          <div class="mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" id="backupCompress" checked>
                              <label class="form-check-label" for="backupCompress">Comprimir backup</label>
                            </div>
                          </div>
                        </form>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="createBackupBtn">Crear Backup</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- DISCORD CONFIG -->
              <div class="tab-pane fade" id="discord-config-pane" role="tabpanel" aria-labelledby="discord-config-tab" tabindex="0">
                <!-- SECCIÓN DE ACTUALIZACIÓN DEL CLIENTE DISCORD -->
                <div class="card fade-in mb-4">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="section-title mb-0"><i class="fab fa-discord"></i> Configuración Discord Client</span>
                  </div>
                  <div class="card-body">
                    <form id="discordClientConfigForm" class="row g-3 align-items-end">
                      <div class="col-md-4">
                        <label for="discordUserId" class="form-label">ID</label>
                        <input type="text" class="form-control" id="discordUserId" maxlength="32" required>
                      </div>
                      <div class="col-md-4">
                        <label for="discordUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="discordUsername" maxlength="32" required>
                      </div>
                      <div class="col-md-4">
                        <label for="discordAvatar" class="form-label">Avatar (URL de imagen)</label>
                        <input type="url" class="form-control" id="discordAvatar" required>
                        <div class="invalid-feedback" id="avatarInvalidFeedback">
                          Debe ser una URL de imagen válida (.png, .jpg, .jpeg, .gif, .webp).
                        </div>
                      </div>
                      <div class="col-md-4">
                        <label for="discordActivityStatus" class="form-label">Activity Status</label>
                        <select class="form-select" id="discordActivityStatus" required>
                          <option value="online">online</option>
                          <option value="idle">idle</option>
                          <option value="dnd">dnd</option>
                          <option value="invisible">invisible</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label for="discordActivityName" class="form-label">Activity Name</label>
                        <input type="text" class="form-control" id="discordActivityName" maxlength="128" required>
                      </div>
                      <div class="col-md-6">
                        <label for="discordActivityUrl" class="form-label">Activity URL (opcional, solo para status "online" y "dnd")</label>
                        <input type="url" class="form-control" id="discordActivityUrl">
                      </div>
                      <div class="col-12 d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="saveDiscordClientConfigBtn">
                          <i class="fas fa-save me-1"></i> Guardar Configuración
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetDiscordClientConfigBtn">
                          <i class="fas fa-undo me-1"></i> Restablecer
                        </button>
                      </div>
                    </form>
                    <div class="mt-4">
                      <h6>Vista previa:</h6>
                      <div class="d-flex align-items-center gap-3" id="discordClientPreview">
                        <img id="discordPreviewAvatar" src="https://i.pinimg.com/736x/38/c2/83/38c283baebbc461a062a2992ae438fbe.jpg" alt="Avatar" style="width:64px;height:64px;border-radius:50%;border:2px solid #5865F2;">
                        <div>
                          <div id="discordPreviewUsername" style="font-weight:600;font-size:1.2em;">Nebura</div>
                          <div id="discordPreviewActivity" style="font-size:0.95em;color:#aaa;">Jugando a Nebura AI Client</div>
                          <div id="discordPreviewStatus" style="font-size:0.9em;">
                            <span class="badge bg-success" id="discordPreviewStatusBadge">online</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div id="discordClientConfigResult" class="mt-3"></div>
                  </div>
                </div>
                <!-- Command Management Section -->
                <div class="card fade-in mb-4">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="section-title mb-0"><i class="fab fa-discord"></i> Discord Command Management</span>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-outline-secondary btn-sm" id="commands-compact-toggle" title="Toggle compact view">
                        <i class="fas fa-compress-arrows-alt"></i>
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" id="commands-columns-toggle" title="Configure columns">
                        <i class="fas fa-table-columns"></i>
                      </button>
                      <div class="dropdown">
                        <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="fas fa-file-export"></i> Export
                        </button>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#" id="export-commands-csv">CSV</a></li>
                          <li><a class="dropdown-item" href="#" id="export-commands-json">JSON</a></li>
                        </ul>
                      </div>
                      <button class="btn btn-primary btn-sm" id="add-command-btn">
                        <i class="fas fa-plus me-1"></i> New Command
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <div class="search-group" id="commands-search-group">
                          <i class="fas fa-search search-icon"></i>
                          <input type="text" id="search-commands" class="form-control form-control-sm" autocomplete="off" placeholder="Search commands..." />
                          <button type="button" class="clear-btn" id="clear-search-commands" tabindex="-1" aria-label="Clear search">
                            <i class="fas fa-times-circle"></i>
                          </button>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <select class="form-select form-select-sm" id="commands-filter-guild">
                          <option value="">All Guilds</option>
                          <!-- Will be populated dynamically -->
                        </select>
                      </div>
                      <div class="col-md-4">
                        <select class="form-select form-select-sm" id="commands-filter-status">
                          <option value="">All Statuses</option>
                          <option value="enabled">Enabled</option>
                          <option value="disabled">Disabled</option>
                        </select>
                      </div>
                    </div>

                    <div class="table-responsive">
                      <table class="table table-hover align-middle mb-0" id="commands-table">
                        <thead>
                          <tr>
                            <th data-sort="name" class="sortable">Name <i class="fa fa-sort"></i></th>
                            <th data-sort="guildId" class="sortable">Guild <i class="fa fa-sort"></i></th>
                            <th data-sort="description" class="sortable">Description <i class="fa fa-sort"></i></th>
                            <th>Response Type</th>
                            <th data-sort="usageCount" class="sortable">Usage <i class="fa fa-sort"></i></th>
                            <th>Status</th>
                            <th data-sort="updatedAt" class="sortable">Last Updated <i class="fa fa-sort"></i></th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody id="commands-table-body">
                          <!-- Will be populated dynamically -->
                        </tbody>
                      </table>
                    </div>

                    <nav class="mt-3">
                      <ul class="pagination pagination-sm justify-content-center" id="commands-pagination"></ul>
                    </nav>
                  </div>
                </div>
                <!-- Tabla de categorías y comandos mejorada -->
                <div class="card fade-in mb-4">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="section-title mb-0"><i class="fas fa-layer-group"></i> Categorías de Comandos</span>
                    <button class="btn btn-primary btn-sm" id="add-category-btn">
                      <i class="fas fa-plus"></i> Nueva Categoría
                    </button>
                  </div>
                  <div class="card-body table-responsive">
                    <table class="table table-hover align-middle" id="categories-table">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Nombre</th>
                          <th>Descripción</th>
                          <th>Estado</th>
                          <th>Comandos</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% categories.forEach((cat, idx) => { 
          const catCommands = components.filter(c => c.categoryId === cat.id);
          const activeCount = catCommands.filter(c => c.enabled).length;
          const inactiveCount = catCommands.length - activeCount;
        %>
                        <tr data-category-id="<%= cat.id %>">
                          <td><span class="badge bg-secondary"><%= idx + 1 %></span></td>
                          <td>
                            <i class="fas fa-folder-open me-1 text-info"></i>
                            <strong><%= cat.name %></strong>
                          </td>
                          <td><%= cat.description || '-' %></td>
                          <td>
                            <span class="badge <%= cat.enabled ? 'bg-success' : 'bg-danger' %>">
                              <%= cat.enabled ? 'Activa' : 'Inactiva' %>
                            </span>
                          </td>
                          <td>
                            <% if (catCommands.length === 0) { %>
                            <span class="text-muted">Sin comandos</span>
                            <% } else { %>
                            <span class="badge bg-success me-1" title="Activos"><i class="fa fa-check"></i> <%= activeCount %></span>
                            <span class="badge bg-danger me-1" title="Inactivos"><i class="fa fa-ban"></i> <%= inactiveCount %></span>
                            <button class="btn btn-link btn-sm p-0 ms-2" data-bs-toggle="collapse" data-bs-target="#cat-cmds-<%= cat.id %>">
                              <i class="fa fa-eye"></i> Ver
                            </button>
                            <div class="collapse mt-2" id="cat-cmds-<%= cat.id %>">
                              <ul class="mb-0 ps-3">
                                <% catCommands.forEach(cmd => { %>
                                <li>
                                  <span class="badge <%= cmd.enabled ? 'bg-success' : 'bg-danger' %>"><%= cmd.name %></span>
                                </li>
                                <% }) %>
                              </ul>
                            </div>
                            <% } %>
                          </td>
                          <td>
                            <div class="dropdown">
                              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                              </button>
                              <ul class="dropdown-menu">
                                <li>
                                  <a class="dropdown-item edit-category-btn" href="#" data-category-id="<%= cat.id %>">
                                    <i class="fas fa-edit me-1"></i> Editar
                                  </a>
                                </li>
                                <li>
                                  <a class="dropdown-item toggle-category-btn" href="#" data-category-id="<%= cat.id %>" data-enabled="<%= cat.enabled %>">
                                    <i class="fas <%= cat.enabled ? 'fa-toggle-off' : 'fa-toggle-on' %> me-1"></i>
                                    <%= cat.enabled ? 'Desactivar' : 'Activar' %>
                                  </a>
                                </li>
                                <li>
                                  <a class="dropdown-item text-danger delete-category-btn" href="#" data-category-id="<%= cat.id %>">
                                    <i class="fas fa-trash me-1"></i> Eliminar
                                  </a>
                                </li>
                              </ul>
                            </div>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>
                <!-- Modal de confirmación para activar/desactivar categoría -->
                <div class="modal fade" id="categoryConfirmModal" tabindex="-1" aria-labelledby="categoryConfirmModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="categoryConfirmModalLabel"><i class="fas fa-exclamation-triangle text-warning"></i> Confirmar acción</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                      </div>
                      <div class="modal-body" id="categoryConfirmModalBody" data-i18n="confirmText">
                        ¿Estás seguro de que deseas realizar esta acción?
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" id="categoryConfirmModalOk" data-i18n="confirm">Confirmar</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Command Modal (Crear/Editar) -->
                <div class="modal fade" id="commandModal" tabindex="-1" aria-labelledby="commandModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="commandModalLabel">Nuevo Comando</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                      </div>
                      <div class="modal-body">
                        <form id="commandForm">
                          <input type="hidden" id="commandId">
                          <div class="row mb-3">
                            <div class="col-md-6">
                              <label for="commandName" class="form-label" data-i18n="commandName">Nombre del Comando *</label>
                              <input type="text" class="form-control" id="commandName" required>
                              <div class="form-text" data-i18n="commandNameDesc">Palabra clave del comando (sin prefijo)</div>
                            </div>
                            <div class="col-md-6">
                              <label for="commandGuild" class="form-label" data-i18n="guildId">Guild ID *</label>
                              <input type="text" class="form-control" id="commandGuild" required>
                              <div class="form-text" data-i18n="guildIdDesc">ID del servidor Discord donde funcionará</div>
                            </div>
                          </div>
                          <div class="mb-3">
                            <label for="commandDescription" class="form-label" data-i18n="commandDescription">Descripción</label>
                            <textarea class="form-control" id="commandDescription" rows="2"></textarea>
                          </div>
                          <div class="row mb-3">
                            <div class="col-md-6">
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="commandEmbed">
                                <label class="form-check-label" for="commandEmbed" data-i18n="useEmbed">Usar respuesta Embed</label>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="commandEnabled" checked>
                                <label class="form-check-label" for="commandEnabled" data-i18n="commandEnabled">Comando habilitado</label>
                              </div>
                            </div>
                          </div>
                          <div class="row mb-3" id="embedSettings" style="display: none;">
                            <div class="col-md-4">
                              <label for="commandEmbedColor" class="form-label">Color del Embed</label>
                              <input type="color" class="form-control form-control-color" id="commandEmbedColor" value="#ff0000" title="Elige color">
                            </div>
                            <div class="col-md-8">
                              <label for="commandEmbedTitle" class="form-label" data-i18n="embedTitle">Título del Embed</label>
                              <input type="text" class="form-control" id="commandEmbedTitle">
                            </div>
                            <div class="col-md-6 mt-3">
                              <label for="commandEmbedFooter" class="form-label" data-i18n="embedFooter">Footer del Embed</label>
                              <input type="text" class="form-control" id="commandEmbedFooter">
                            </div>
                            <div class="col-md-6 mt-3">
                              <label for="commandEmbedAuthor" class="form-label" data-i18n="embedAuthor">Autor del Embed</label>
                              <input type="text" class="form-control" id="commandEmbedAuthor">
                            </div>
                            <div class="col-md-6 mt-3">
                              <label <input type="text" class="form-control" id="commandEmbedAuthor">
                            </div>
                            <div class="col-md-6 mt-3">
                              <label for="commandEmbedThumbnail" class="form-label">URL Thumbnail</label>
                              <input type="text" class="form-control" id="commandEmbedThumbnail">
                            </div>
                            <div class="col-md-6 mt-3">
                              <label for="commandEmbedImage" class="form-label">URL Imagen</label>
                              <input type="text" class="form-control" id="commandEmbedImage">
                            </div>
                            <div class="col-12 mt-3">
                              <label for="commandEmbedFields" class="form-label">Campos del Embed (Fields)</label>
                              <textarea class="form-control json-input" id="commandEmbedFields" rows="3" placeholder='[{"name":"Field 1","value":"Value 1","inline":true},{"name":"Field 2","value":"Value 2","inline":false}]'></textarea>
                              <div class="form-text">
                                Array JSON de campos. Cada campo requiere: name, value. Opcional: inline (true/false)
                              </div>
                            </div>
                          </div>
                          <div class="mb-3">
                            <label for="commandResponse" class="form-label">Contenido de Respuesta *</label>
                            <textarea class="form-control" id="commandResponse" rows="4" required></textarea>
                            <div class="form-text">Mensaje que responderá el bot. Soporta markdown.</div>
                          </div>
                          <div class="mb-3">
                            <label for="commandFile" class="form-label">URL de archivo adjunto</label>
                            <input type="text" class="form-control" id="commandFile">
                            <div class="form-text">URL de archivo a adjuntar en la respuesta</div>
                          </div>
                          <div class="mb-3">
                            <label for="commandButtons" class="form-label">Configuración de Botones</label>
                            <textarea class="form-control" id="commandButtons" rows="3" placeholder='[{"label":"Button 1","style":"PRIMARY","customId":"button1"},{"label":"Button 2","style":"SECONDARY","customId":"button2"}]'></textarea>
                            <div class="form-text">
                              Array JSON de botones. Cada botón requiere: label, style (PRIMARY, SECONDARY, SUCCESS, DANGER), y customId
                            </div>
                          </div>
                          <div class="card mt-3" id="embedPreviewCard" style="display: none;">
                            <div class="card-header">
                              <h6 class="mb-0">Vista previa del Embed</h6>
                            </div>
                            <div class="card-body">
                              <div class="embed-preview">
                                <div id="embedPreviewContent"></div>
                              </div>
                            </div>
                          </div>
                        </form>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="saveCommandBtn">Guardar Comando</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Modales de CRUD de Cliente/Discord/Whatsapp deben quedar fuera de los subtabs para que funcionen correctamente -->
            <!-- Modal para CRUD de Clientes -->
            <div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="clientModalLabel">Nuevo Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <form id="clientForm">
                      <input type="hidden" id="clientId">
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="clientName" class="form-label">Nombre</label>
                          <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="col-md-6">
                          <label for="clientVersion" class="form-label">Versión</label>
                          <input type="text" class="form-control" id="clientVersion" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="clientMaintenance" class="form-label">Mantenimiento</label>
                          <select class="form-select" id="clientMaintenance" required>
                            <option value="false">No</option>
                            <option value="true">Sí</option>
                          </select>
                        </div>
                        <!-- Puedes agregar más campos si tu modelo lo requiere -->
                      </div>
                      <!-- Campos adicionales opcionales, ocultos para compatibilidad -->
                      <input type="hidden" id="clientEmail">
                      <input type="hidden" id="clientPhone">
                      <input type="hidden" id="clientStatus">
                      <input type="hidden" id="clientNotes">
                    </form>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveClientBtn">Guardar</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal para CRUD de Discord -->
            <div class="modal fade" id="discordModal" tabindex="-1" aria-labelledby="discordModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="discordModalLabel">Nueva Configuración de Discord</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <form id="discordForm">
                      <input type="hidden" id="discordId">
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="discordToken" class="form-label">Token</label>
                          <input type="text" class="form-control" id="discordToken" required>
                        </div>
                        <div class="col-md-6">
                          <label for="discordClientId" class="form-label">Client ID</label>
                          <input type="text" class="form-control" id="discordClientId" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="discordWebhook" class="form-label">Webhook URL</label>
                          <input type="url" class="form-control" id="discordWebhook">
                        </div>
                        <div class="col-md-6">
                          <label for="discordStatus" class="form-label">Estado</label>
                          <select class="form-select" id="discordStatus" required>
                            <option value="active">Activo</option>
                            <option value="inactive">Inactivo</option>
                          </select>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label for="discordConfig" class="form-label">Configuración Adicional (JSON)</label>
                        <textarea class="form-control" id="discordConfig" rows="3"></textarea>
                      </div>
                    </form>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveDiscordBtn">Guardar</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal para CRUD de WhatsApp -->
            <div class="modal fade" id="whatsappModal" tabindex="-1" aria-labelledby="whatsappModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="whatsappModalLabel">Nueva Configuración de WhatsApp</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <form id="whatsappForm">
                      <input type="hidden" id="whatsappId">
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="whatsappNumber" class="form-label">Número</label>
                          <input type="text" class="form-control" id="whatsappNumber" required>
                        </div>
                        <div class="col-md-6">
                          <label for="whatsappApiKey" class="form-label">API Key</label>
                          <input type="text" class="form-control" id="whatsappApiKey" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="whatsappWebhook" class="form-label">Webhook URL</label>
                          <input type="url" class="form-control" id="whatsappWebhook">
                        </div>
                        <div class="col-md-6">
                          <label for="whatsappStatus" class="form-label">Estado</label>
                          <select class="form-select" id="whatsappStatus" required>
                            <option value="active">Activo</option>
                            <option value="inactive">Inactivo</option>
                          </select>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label for="whatsappConfig" class="form-label">Configuración Adicional (JSON)</label>
                        <textarea class="form-control" id="whatsappConfig" rows="3"></textarea>
                      </div>
                    </form>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveWhatsappBtn">Guardar</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- TAB TASKS -->
          <div class="tab-pane fade" id="tasks-tab-pane" role="tabpanel" aria-labelledby="tasks-tab" tabindex="0">
            <%- include('partials/utils/tasks') %>
          </div>
          <!-- NUEVA TAB PARA LICENCIAS UI -->
          <div class="tab-pane fade" id="licensesui-tab-pane" role="tabpanel" aria-labelledby="licensesui-tab" tabindex="0">
            <%- include('partials/utils/licences', { user: user }) %>
          </div>
      </main>
    </div>
  </div>


  <!-- Toast para notificaciones -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toast-title">Notificación</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-body">Mensaje de notificación</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@3.3.0/tsparticles.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="/scripts/administrator/administrator.js"></script>
  <script src="/scripts/administrator/particles.js"></script>
  <script src="/scripts/administrator/command.js"></script>
  <script src="/scripts/administrator/discord.js"></script>
  <script src="/scripts/administrator/config.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var link = document.getElementById('tickets-link');
      if (link && window.userIdFromUrl) {
        link.href = '/dashboard/administrator/tickets?id=<%- userIdFromUrl %>';
      }

      // Handler para activar/desactivar desde el menú contextual
      document.querySelectorAll('.toggle-category-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const catId = this.getAttribute('data-category-id');
          const enabled = this.getAttribute('data-enabled') === 'true';
          const modal = new bootstrap.Modal(document.getElementById('categoryConfirmModal'));
          const body = document.getElementById('categoryConfirmModalBody');
          body.textContent = enabled ?
            '¿Desactivar esta categoría? Todos los comandos de la categoría serán desactivados visualmente.' :
            '¿Activar esta categoría? Todos los comandos de la categoría serán activados visualmente.';
          modal.show();

          const okBtn = document.getElementById('categoryConfirmModalOk');
          okBtn.onclick = async () => {
            modal.hide();
            // PATCH request para activar/desactivar la categoría (igual que antes)
            await fetch(`/dashboard/utils/discord/category/${catId}/enable`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                enabled: !enabled
              })
            });
            // Actualiza la tabla de comandos visualmente
            document.querySelectorAll(`#commands-table tbody tr`).forEach(row => {
              if (row.dataset.categoryId === catId) {
                row.classList.toggle('table-danger', enabled); // marca en rojo si desactivado
                // Opcional: deshabilita botones de acción
                row.querySelectorAll('button, a').forEach(el => el.disabled = enabled);
              }
            });
            // Opcional: recarga la página o actualiza la tabla de categorías
            location.reload();
          };
        });
      });

      // Función toast reutilizable
      function showToast(title, body, error) {
        const toastEl = document.getElementById('notificationToast');
        document.getElementById('toast-title').textContent = title;
        document.getElementById('toast-body').textContent = body;
        toastEl.classList.toggle('bg-danger', !!error);
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      }
    });
  </script>
  <!-- Script para manejar los backups -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Variable para almacenar los datos del backup actual
      let currentBackupData = null;

      // Manejador para el botón de refrescar
      document.getElementById('refresh-backups-btn').addEventListener('click', function() {
        location.reload();
      });

      // Manejador para el botón de crear backup
      document.getElementById('create-backup-btn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('backupModal'));
        modal.show();
      });

      // Manejador para crear backup
      document.getElementById('createBackupBtn').addEventListener('click', function() {
        const description = document.getElementById('backupDescription').value;
        const compress = document.getElementById('backupCompress').checked;

        fetch('/dashboard/utils/backups/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              description,
              compress
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('Éxito', 'Backup creado correctamente', false);
              location.reload();
            } else {
              showToast('Error', data.message || 'Error al crear el backup', true);
            }
          })
          .catch(error => {
            showToast('Error', 'Error al crear el backup: ' + error.message, true);
          });
      });

      // Manejador para ver backup
      document.querySelectorAll('.view-backup-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const backupFile = this.getAttribute('data-backup-file');
          document.getElementById('backup-details-title').textContent = backupFile;

          // Mostrar spinner mientras se carga
          document.getElementById('backup-summary').innerHTML = '<li class="list-group-item bg-dark">Cargando...</li>';
          document.getElementById('backup-data-body').innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">Cargando...</td></tr>';

          // Obtener el contenido del backup
          fetch(`/dashboard/utils/backups/get?file=${encodeURIComponent(backupFile)}`)
            .then(response => response.json())
            .then(data => {
              currentBackupData = data;
              updateBackupDetails(data);
              document.getElementById('backup-details-card').style.display = 'block';

              // Desplazarse a la sección de detalles
              document.getElementById('backup-details-card').scrollIntoView({
                behavior: 'smooth'
              });
            })
            .catch(error => {
              showToast('Error', 'No se pudo cargar el backup: ' + error.message, true);
            });
        });
      });

      // Manejador para cerrar detalles
      document.getElementById('close-backup-details').addEventListener('click', function() {
        document.getElementById('backup-details-card').style.display = 'none';
        currentBackupData = null;
      });

      // Manejador para seleccionar datos del backup
      document.getElementById('backup-data-select').addEventListener('change', function() {
        if (!currentBackupData) return;

        const category = this.value;
        const tableBody = document.getElementById('backup-data-body');

        if (!category) {
          tableBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">Selecciona una categoría para ver los datos</td></tr>';
          return;
        }

        const items = currentBackupData[category] || [];

        if (items.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">No hay datos en esta categoría</td></tr>';
          return;
        }

        // Limitar a 50 elementos para no sobrecargar la UI
        const displayItems = items.slice(0, 50);

        tableBody.innerHTML = displayItems.map(item => {
          let details = '';
          if (category === 'userAPI') {
            details = `${item.name} (${item.email}) - ${item.role}`;
          } else if (category === 'license') {
            details = `${item.type} - ${item.status} - ${item.userId}`;
          } else if (category === 'myDiscord') {
            details = `${item.clientId} - ${item.token.slice(0, 10)}...`;
          } else if (category === 'myGuild') {
            details = `Guild: ${item.guildId} - Prefix: ${item.prefix || '!'}`;
          } else if (category === 'userEconomy') {
            details = `User: ${item.userId} - Balance: ${item.balance}`;
          } else if (category === 'userLevel') {
            details = `User: ${item.userId} - Level: ${item.level} - XP: ${item.xp}`;
          } else if (category === 'metrics') {
            details = `Endpoint: ${item.endpoint} - Requests: ${item.requests}`;
          } else {
            details = JSON.stringify(item, null, 2);
          }

          return `
          <tr>
            <td><code>${item.id || item.userId || item.guildId || 'N/A'}</code></td>
            <td>${details}</td>
          </tr>
        `;
        }).join('');

        if (items.length > 50) {
          tableBody.innerHTML += `
          <tr>
            <td colspan="2" class="text-center text-muted">
              Mostrando 50 de ${items.length} elementos. Descarga el backup para ver todos.
            </td>
          </tr>
        `;
        }
      });

      // Manejador para eliminar backup
      document.querySelectorAll('.delete-backup-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const backupFile = this.getAttribute('data-backup-file');
          const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
          document.getElementById('confirmModalBody').textContent = `¿Estás seguro de que deseas eliminar el backup "${backupFile}"? Esta acción no se puede deshacer.`;
          modal.show();

          document.getElementById('confirmModalOk').onclick = function() {
            modal.hide();

            fetch(`/dashboard/utils/backups/delete?file=${encodeURIComponent(backupFile)}`, {
                method: 'DELETE'
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  showToast('Éxito', `Backup "${backupFile}" eliminado`, false);
                  // Eliminar la fila de la tabla
                  document.querySelector(`tr[data-backup-file="${backupFile}"]`).remove();

                  // Si no quedan backups, mostrar mensaje
                  if (document.querySelectorAll('#backups-table-body tr').length === 0) {
                    document.getElementById('backups-table-body').innerHTML = `
                  <tr>
                    <td colspan="5" class="text-center text-muted py-4">No hay backups disponibles</td>
                  </tr>
                `;
                  }
                } else {
                  showToast('Error', data.message || 'Error al eliminar el backup', true);
                }
              })
              .catch(error => {
                showToast('Error', 'Error al eliminar el backup: ' + error.message, true);
              });
          };
        });
      });

      // Función para actualizar los detalles del backup
      function updateBackupDetails(backupData) {
        // Actualizar resumen
        const summaryItems = [{
            name: 'Usuarios API',
            count: backupData.userAPI?.length || 0
          },
          {
            name: 'Licencias',
            count: backupData.license?.length || 0
          },
          {
            name: 'Clientes Discord',
            count: backupData.myDiscord?.length || 0
          },
          {
            name: 'Servidores',
            count: backupData.myGuild?.length || 0
          },
          {
            name: 'Usuarios de Economía',
            count: backupData.userEconomy?.length || 0
          },
          {
            name: 'Usuarios de Niveles',
            count: backupData.userLevel?.length || 0
          },
          {
            name: 'Métricas',
            count: backupData.metrics?.length || 0
          }
        ];

        document.getElementById('backup-summary').innerHTML = summaryItems.map(item => `
        <li class="list-group-item bg-dark d-flex justify-content-between align-items-center">
          ${item.name}
          <span class="badge bg-primary rounded-pill">${item.count}</span>
        </li>
      `).join('');

        // Actualizar JSON viewer
        document.getElementById('backup-json-viewer').textContent = JSON.stringify(backupData, null, 2);

        // Resaltar sintaxis (opcional, requiere una librería como highlight.js)
        if (window.hljs) {
          hljs.highlightElement(document.getElementById('backup-json-viewer'));
        }
      }

      // Función para mostrar notificaciones
      function showToast(title, body, error) {
        const toastEl = document.getElementById('notificationToast');
        document.getElementById('toast-title').textContent = title;
        document.getElementById('toast-body').textContent = body;

        // Cambiar color si es error
        const header = toastEl.querySelector('.toast-header');
        if (error) {
          header.classList.add('bg-danger', 'text-white');
          header.classList.remove('bg-primary');
        } else {
          header.classList.add('bg-primary', 'text-white');
          header.classList.remove('bg-danger');
        }

        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      }
    });
  </script>
  <!-- Modal de confirmación -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel"><i class="fas fa-exclamation-triangle text-warning"></i>
            Confirmar acción</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">
          ¿Estás seguro de que deseas realizar esta acción?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmModalOk">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal columnas configurables -->
  <div class="modal fade" id="columnsModal" tabindex="-1" aria-labelledby="columnsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="columnsModalLabel"><i class="fas fa-table-columns"></i> Seleccionar columnas
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="columnsModalBody">
          <!-- Se rellena dinámicamente -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="columnsModalApply">Aplicar</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>